
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../advanced/">
      
      
      
      <link rel="icon" href="../assets/skull.svg">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.39">
    
    
      
        <title>Code reference - Gibbs</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.8c3ca2c6.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../css/mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="amber">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#code-reference" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
          <aside class="md-banner md-banner--warning">
            <div class="md-banner__inner md-grid md-typeset">
              
  You're not viewing the latest stable version.
  <a href="../..">

    <strong>Go to latest stable version.</strong>
  </a>

            </div>
            <script>var el=document.querySelector("[data-md-component=outdated]"),outdated=__md_get("__outdated",sessionStorage);!0===outdated&&el&&(el.hidden=!1)</script>
          </aside>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Gibbs" class="md-header__button md-logo" aria-label="Gibbs" data-md-component="logo">
      
  <img src="../assets/skull.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Gibbs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Code reference
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="amber"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="amber"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/astariul/gibbs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    astariul/gibbs
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Gibbs" class="md-nav__button md-logo" aria-label="Gibbs" data-md-component="logo">
      
  <img src="../assets/skull.svg" alt="logo">

    </a>
    Gibbs
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/astariul/gibbs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    astariul/gibbs
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Welcome
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../usage/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Usage
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Examples
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../architecture/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Architecture
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../advanced/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Advanced
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Code reference
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Code reference
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#api" class="md-nav__link">
    <span class="md-ellipsis">
      API
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gibbs.hub" class="md-nav__link">
    <span class="md-ellipsis">
      hub
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gibbs.hub.Hub" class="md-nav__link">
    <span class="md-ellipsis">
      Hub
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Hub">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gibbs.hub.Hub.receive_loop" class="md-nav__link">
    <span class="md-ellipsis">
      receive_loop
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gibbs.hub.Hub.request" class="md-nav__link">
    <span class="md-ellipsis">
      request
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gibbs.hub.RequestManager" class="md-nav__link">
    <span class="md-ellipsis">
      RequestManager
    </span>
  </a>
  
    <nav class="md-nav" aria-label="RequestManager">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gibbs.hub.RequestManager.pin" class="md-nav__link">
    <span class="md-ellipsis">
      pin
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gibbs.hub.RequestManager.store" class="md-nav__link">
    <span class="md-ellipsis">
      store
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gibbs.hub.RequestManager.wait_for" class="md-nav__link">
    <span class="md-ellipsis">
      wait_for
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gibbs.hub.UserCodeException" class="md-nav__link">
    <span class="md-ellipsis">
      UserCodeException
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gibbs.hub.WorkerManager" class="md-nav__link">
    <span class="md-ellipsis">
      WorkerManager
    </span>
  </a>
  
    <nav class="md-nav" aria-label="WorkerManager">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gibbs.hub.WorkerManager.get_next_worker" class="md-nav__link">
    <span class="md-ellipsis">
      get_next_worker
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gibbs.hub.WorkerManager.reckon" class="md-nav__link">
    <span class="md-ellipsis">
      reckon
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gibbs.worker" class="md-nav__link">
    <span class="md-ellipsis">
      worker
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gibbs.worker.Worker" class="md-nav__link">
    <span class="md-ellipsis">
      Worker
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Worker">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gibbs.worker.Worker.create_socket" class="md-nav__link">
    <span class="md-ellipsis">
      create_socket
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gibbs.worker.Worker.create_term_socket" class="md-nav__link">
    <span class="md-ellipsis">
      create_term_socket
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gibbs.worker.Worker.ping" class="md-nav__link">
    <span class="md-ellipsis">
      ping
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gibbs.worker.Worker.reset_socket" class="md-nav__link">
    <span class="md-ellipsis">
      reset_socket
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gibbs.worker.Worker.run" class="md-nav__link">
    <span class="md-ellipsis">
      run
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#internal" class="md-nav__link">
    <span class="md-ellipsis">
      Internal
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gibbs.hub" class="md-nav__link">
    <span class="md-ellipsis">
      hub
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gibbs.hub.Hub" class="md-nav__link">
    <span class="md-ellipsis">
      Hub
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Hub">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gibbs.hub.Hub.receive_loop" class="md-nav__link">
    <span class="md-ellipsis">
      receive_loop
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gibbs.hub.Hub.request" class="md-nav__link">
    <span class="md-ellipsis">
      request
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gibbs.hub.RequestManager" class="md-nav__link">
    <span class="md-ellipsis">
      RequestManager
    </span>
  </a>
  
    <nav class="md-nav" aria-label="RequestManager">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gibbs.hub.RequestManager.pin" class="md-nav__link">
    <span class="md-ellipsis">
      pin
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gibbs.hub.RequestManager.store" class="md-nav__link">
    <span class="md-ellipsis">
      store
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gibbs.hub.RequestManager.wait_for" class="md-nav__link">
    <span class="md-ellipsis">
      wait_for
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gibbs.hub.UserCodeException" class="md-nav__link">
    <span class="md-ellipsis">
      UserCodeException
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gibbs.hub.WorkerManager" class="md-nav__link">
    <span class="md-ellipsis">
      WorkerManager
    </span>
  </a>
  
    <nav class="md-nav" aria-label="WorkerManager">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gibbs.hub.WorkerManager.get_next_worker" class="md-nav__link">
    <span class="md-ellipsis">
      get_next_worker
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gibbs.hub.WorkerManager.reckon" class="md-nav__link">
    <span class="md-ellipsis">
      reckon
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#constants" class="md-nav__link">
    <span class="md-ellipsis">
      Constants
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gibbs.hub" class="md-nav__link">
    <span class="md-ellipsis">
      hub
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gibbs.hub.Hub" class="md-nav__link">
    <span class="md-ellipsis">
      Hub
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Hub">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gibbs.hub.Hub.receive_loop" class="md-nav__link">
    <span class="md-ellipsis">
      receive_loop
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gibbs.hub.Hub.request" class="md-nav__link">
    <span class="md-ellipsis">
      request
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gibbs.hub.RequestManager" class="md-nav__link">
    <span class="md-ellipsis">
      RequestManager
    </span>
  </a>
  
    <nav class="md-nav" aria-label="RequestManager">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gibbs.hub.RequestManager.pin" class="md-nav__link">
    <span class="md-ellipsis">
      pin
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gibbs.hub.RequestManager.store" class="md-nav__link">
    <span class="md-ellipsis">
      store
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gibbs.hub.RequestManager.wait_for" class="md-nav__link">
    <span class="md-ellipsis">
      wait_for
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gibbs.hub.UserCodeException" class="md-nav__link">
    <span class="md-ellipsis">
      UserCodeException
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gibbs.hub.WorkerManager" class="md-nav__link">
    <span class="md-ellipsis">
      WorkerManager
    </span>
  </a>
  
    <nav class="md-nav" aria-label="WorkerManager">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gibbs.hub.WorkerManager.get_next_worker" class="md-nav__link">
    <span class="md-ellipsis">
      get_next_worker
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gibbs.hub.WorkerManager.reckon" class="md-nav__link">
    <span class="md-ellipsis">
      reckon
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gibbs.worker" class="md-nav__link">
    <span class="md-ellipsis">
      worker
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gibbs.worker.Worker" class="md-nav__link">
    <span class="md-ellipsis">
      Worker
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Worker">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gibbs.worker.Worker.create_socket" class="md-nav__link">
    <span class="md-ellipsis">
      create_socket
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gibbs.worker.Worker.create_term_socket" class="md-nav__link">
    <span class="md-ellipsis">
      create_term_socket
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gibbs.worker.Worker.ping" class="md-nav__link">
    <span class="md-ellipsis">
      ping
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gibbs.worker.Worker.reset_socket" class="md-nav__link">
    <span class="md-ellipsis">
      reset_socket
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gibbs.worker.Worker.run" class="md-nav__link">
    <span class="md-ellipsis">
      run
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#api" class="md-nav__link">
    <span class="md-ellipsis">
      API
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gibbs.hub" class="md-nav__link">
    <span class="md-ellipsis">
      hub
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gibbs.hub.Hub" class="md-nav__link">
    <span class="md-ellipsis">
      Hub
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Hub">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gibbs.hub.Hub.receive_loop" class="md-nav__link">
    <span class="md-ellipsis">
      receive_loop
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gibbs.hub.Hub.request" class="md-nav__link">
    <span class="md-ellipsis">
      request
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gibbs.hub.RequestManager" class="md-nav__link">
    <span class="md-ellipsis">
      RequestManager
    </span>
  </a>
  
    <nav class="md-nav" aria-label="RequestManager">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gibbs.hub.RequestManager.pin" class="md-nav__link">
    <span class="md-ellipsis">
      pin
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gibbs.hub.RequestManager.store" class="md-nav__link">
    <span class="md-ellipsis">
      store
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gibbs.hub.RequestManager.wait_for" class="md-nav__link">
    <span class="md-ellipsis">
      wait_for
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gibbs.hub.UserCodeException" class="md-nav__link">
    <span class="md-ellipsis">
      UserCodeException
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gibbs.hub.WorkerManager" class="md-nav__link">
    <span class="md-ellipsis">
      WorkerManager
    </span>
  </a>
  
    <nav class="md-nav" aria-label="WorkerManager">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gibbs.hub.WorkerManager.get_next_worker" class="md-nav__link">
    <span class="md-ellipsis">
      get_next_worker
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gibbs.hub.WorkerManager.reckon" class="md-nav__link">
    <span class="md-ellipsis">
      reckon
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gibbs.worker" class="md-nav__link">
    <span class="md-ellipsis">
      worker
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gibbs.worker.Worker" class="md-nav__link">
    <span class="md-ellipsis">
      Worker
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Worker">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gibbs.worker.Worker.create_socket" class="md-nav__link">
    <span class="md-ellipsis">
      create_socket
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gibbs.worker.Worker.create_term_socket" class="md-nav__link">
    <span class="md-ellipsis">
      create_term_socket
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gibbs.worker.Worker.ping" class="md-nav__link">
    <span class="md-ellipsis">
      ping
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gibbs.worker.Worker.reset_socket" class="md-nav__link">
    <span class="md-ellipsis">
      reset_socket
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gibbs.worker.Worker.run" class="md-nav__link">
    <span class="md-ellipsis">
      run
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#internal" class="md-nav__link">
    <span class="md-ellipsis">
      Internal
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gibbs.hub" class="md-nav__link">
    <span class="md-ellipsis">
      hub
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gibbs.hub.Hub" class="md-nav__link">
    <span class="md-ellipsis">
      Hub
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Hub">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gibbs.hub.Hub.receive_loop" class="md-nav__link">
    <span class="md-ellipsis">
      receive_loop
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gibbs.hub.Hub.request" class="md-nav__link">
    <span class="md-ellipsis">
      request
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gibbs.hub.RequestManager" class="md-nav__link">
    <span class="md-ellipsis">
      RequestManager
    </span>
  </a>
  
    <nav class="md-nav" aria-label="RequestManager">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gibbs.hub.RequestManager.pin" class="md-nav__link">
    <span class="md-ellipsis">
      pin
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gibbs.hub.RequestManager.store" class="md-nav__link">
    <span class="md-ellipsis">
      store
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gibbs.hub.RequestManager.wait_for" class="md-nav__link">
    <span class="md-ellipsis">
      wait_for
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gibbs.hub.UserCodeException" class="md-nav__link">
    <span class="md-ellipsis">
      UserCodeException
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gibbs.hub.WorkerManager" class="md-nav__link">
    <span class="md-ellipsis">
      WorkerManager
    </span>
  </a>
  
    <nav class="md-nav" aria-label="WorkerManager">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gibbs.hub.WorkerManager.get_next_worker" class="md-nav__link">
    <span class="md-ellipsis">
      get_next_worker
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gibbs.hub.WorkerManager.reckon" class="md-nav__link">
    <span class="md-ellipsis">
      reckon
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#constants" class="md-nav__link">
    <span class="md-ellipsis">
      Constants
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gibbs.hub" class="md-nav__link">
    <span class="md-ellipsis">
      hub
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gibbs.hub.Hub" class="md-nav__link">
    <span class="md-ellipsis">
      Hub
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Hub">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gibbs.hub.Hub.receive_loop" class="md-nav__link">
    <span class="md-ellipsis">
      receive_loop
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gibbs.hub.Hub.request" class="md-nav__link">
    <span class="md-ellipsis">
      request
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gibbs.hub.RequestManager" class="md-nav__link">
    <span class="md-ellipsis">
      RequestManager
    </span>
  </a>
  
    <nav class="md-nav" aria-label="RequestManager">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gibbs.hub.RequestManager.pin" class="md-nav__link">
    <span class="md-ellipsis">
      pin
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gibbs.hub.RequestManager.store" class="md-nav__link">
    <span class="md-ellipsis">
      store
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gibbs.hub.RequestManager.wait_for" class="md-nav__link">
    <span class="md-ellipsis">
      wait_for
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gibbs.hub.UserCodeException" class="md-nav__link">
    <span class="md-ellipsis">
      UserCodeException
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gibbs.hub.WorkerManager" class="md-nav__link">
    <span class="md-ellipsis">
      WorkerManager
    </span>
  </a>
  
    <nav class="md-nav" aria-label="WorkerManager">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gibbs.hub.WorkerManager.get_next_worker" class="md-nav__link">
    <span class="md-ellipsis">
      get_next_worker
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gibbs.hub.WorkerManager.reckon" class="md-nav__link">
    <span class="md-ellipsis">
      reckon
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gibbs.worker" class="md-nav__link">
    <span class="md-ellipsis">
      worker
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gibbs.worker.Worker" class="md-nav__link">
    <span class="md-ellipsis">
      Worker
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Worker">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gibbs.worker.Worker.create_socket" class="md-nav__link">
    <span class="md-ellipsis">
      create_socket
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gibbs.worker.Worker.create_term_socket" class="md-nav__link">
    <span class="md-ellipsis">
      create_term_socket
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gibbs.worker.Worker.ping" class="md-nav__link">
    <span class="md-ellipsis">
      ping
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gibbs.worker.Worker.reset_socket" class="md-nav__link">
    <span class="md-ellipsis">
      reset_socket
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gibbs.worker.Worker.run" class="md-nav__link">
    <span class="md-ellipsis">
      run
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="code-reference">Code reference</h1>
<h2 id="api">API</h2>


<div class="doc doc-object doc-module">



<a id="gibbs.hub"></a>
    <div class="doc doc-contents first">



  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="gibbs.hub.Hub" class="doc doc-heading">
            <code>Hub</code>


</h2>


    <div class="doc doc-contents ">


        <p>Class acting as a hub for all the requests to send. All requests sent
through this class will be automatically dispatched to connected workers,
will wait for the responses and return it.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>port</code></td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Port number to use for the sockets. Defaults to
DEFAULT_PORT.</p>
              </div>
            </td>
            <td>
                  <code><span title="gibbs.worker.DEFAULT_PORT">DEFAULT_PORT</span></code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>heartbeat_interval</code></td>
            <td>
                  <code>float</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Heartbeat interval used by the
workers, in seconds. Defaults to DEFAULT_HEARTBEAT_INTERVAL.</p>
              </div>
            </td>
            <td>
                  <code><span title="gibbs.worker.DEFAULT_HEARTBEAT_INTERVAL">DEFAULT_HEARTBEAT_INTERVAL</span></code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>resp_buffer_size</code></td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum response buffer size. Defaults
to RESPONSE_BUFFER_SIZE.</p>
              </div>
            </td>
            <td>
                  <code><span title="gibbs.hub.RESPONSE_BUFFER_SIZE">RESPONSE_BUFFER_SIZE</span></code>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>gibbs/hub.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Hub</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Class acting as a hub for all the requests to send. All requests sent</span>
<span class="sd">    through this class will be automatically dispatched to connected workers,</span>
<span class="sd">    will wait for the responses and return it.</span>

<span class="sd">    Args:</span>
<span class="sd">        port (int): Port number to use for the sockets. Defaults to</span>
<span class="sd">            DEFAULT_PORT.</span>
<span class="sd">        heartbeat_interval (float): Heartbeat interval used by the</span>
<span class="sd">            workers, in seconds. Defaults to DEFAULT_HEARTBEAT_INTERVAL.</span>
<span class="sd">        resp_buffer_size (int): Maximum response buffer size. Defaults</span>
<span class="sd">            to RESPONSE_BUFFER_SIZE.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_PORT</span><span class="p">,</span>
        <span class="n">heartbeat_interval</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">DEFAULT_HEARTBEAT_INTERVAL</span><span class="p">,</span>
        <span class="n">resp_buffer_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">RESPONSE_BUFFER_SIZE</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">heartbeat_t</span> <span class="o">=</span> <span class="n">heartbeat_interval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_manager</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">req_manager</span> <span class="o">=</span> <span class="n">RequestManager</span><span class="p">(</span><span class="n">resp_buffer_size</span><span class="o">=</span><span class="n">resp_buffer_size</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">receive_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Infinite loop for receiving responses from the workers.&quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># Receive stuff</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Receiving...&quot;</span><span class="p">)</span>
            <span class="n">address</span><span class="p">,</span> <span class="o">*</span><span class="n">frames</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">recv_multipart</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received something from worker #</span><span class="si">{</span><span class="n">address</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Since we received a response from this worker, it means it&#39;s ready for more !</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_manager</span><span class="o">.</span><span class="n">reckon</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">frames</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Answer the Ping</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Answering the ping&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">send_multipart</span><span class="p">([</span><span class="n">address</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">PONG</span><span class="p">])</span>
                <span class="k">continue</span>

            <span class="n">_</span><span class="p">,</span> <span class="n">resp</span> <span class="o">=</span> <span class="n">frames</span>
            <span class="n">req_id</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">res</span> <span class="o">=</span> <span class="n">msgpack</span><span class="o">.</span><span class="n">unpackb</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received response from request #</span><span class="si">{</span><span class="n">req_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">req_manager</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">req_id</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_start_if_not_started</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper method to ensure everything is properly started (socket is</span>
<span class="sd">        initialized, receiving loop is started, etc...).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Create what we need here in this process/context</span>
            <span class="n">context</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">asyncio</span><span class="o">.</span><span class="n">Context</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">ROUTER</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tcp://*:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">w_manager</span> <span class="o">=</span> <span class="n">WorkerManager</span><span class="p">(</span><span class="n">heartbeat_interval</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">heartbeat_t</span><span class="p">)</span>

            <span class="c1"># Fire and forget : infinite loop, taking care of receiving stuff from the socket</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting receiving loop...&quot;</span><span class="p">)</span>
            <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">receive_loop</span><span class="p">())</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Raw method to send a request. This method will do the following :</span>
<span class="sd">         * Start the receiving loop if it was not started</span>
<span class="sd">         * Get the address of the next worker ready (blocking)</span>
<span class="sd">         * Send the request to the worker</span>
<span class="sd">         * Wait for the response (blocking)</span>
<span class="sd">         * Return the result</span>

<span class="sd">        Args:</span>
<span class="sd">            *args: Positional arguments for the request.</span>
<span class="sd">            **kwargs: Keywords arguments for the request.</span>

<span class="sd">        Raises:</span>
<span class="sd">            UserCodeException: Exception raised if an exception was raised inside</span>
<span class="sd">                user-defined code on the worker side.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Any: The response for the request.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Before anything, if the receiving loop was not started, start it</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_if_not_started</span><span class="p">()</span>

        <span class="c1"># Assign a unique ID to the request</span>
        <span class="n">req_id</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span>

        <span class="c1"># Let the manager know that we are waiting for this request</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pinning request #</span><span class="si">{</span><span class="n">req_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">req_manager</span><span class="o">.</span><span class="n">pin</span><span class="p">(</span><span class="n">req_id</span><span class="p">)</span>

        <span class="c1"># Send the request</span>
        <span class="n">address</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_manager</span><span class="o">.</span><span class="n">get_next_worker</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sending request #</span><span class="si">{</span><span class="n">req_id</span><span class="si">}</span><span class="s2"> to worker #</span><span class="si">{</span><span class="n">address</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">send_multipart</span><span class="p">([</span><span class="n">address</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">msgpack</span><span class="o">.</span><span class="n">packb</span><span class="p">([</span><span class="n">req_id</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">])])</span>

        <span class="c1"># Wait until we receive the response</span>
        <span class="n">code</span><span class="p">,</span> <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">req_manager</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span><span class="n">req_id</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received result for request #</span><span class="si">{</span><span class="n">req_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Depending on what is the response, deal with it properly</span>
        <span class="k">if</span> <span class="n">code</span> <span class="o">==</span> <span class="n">CODE_FAILURE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UserCodeException</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">res</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">gibbs_timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">gibbs_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Main method, used to send a request to workers and get the result.</span>

<span class="sd">        This method is a wrapper around `_request`, providing additional</span>
<span class="sd">        functionalities :</span>
<span class="sd">         * Timeout</span>
<span class="sd">         * Automatic retries</span>

<span class="sd">        Args:</span>
<span class="sd">            *args: Positional arguments for the request.</span>
<span class="sd">            gibbs_timeout (float): Timeout for the request, in seconds.</span>
<span class="sd">                If `None` is given, block until the request is complete.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            gibbs_retries (int): Number of retries. This argument is</span>
<span class="sd">                used only if `gibbs_timeout` is not `None`. If `-1` is given,</span>
<span class="sd">                indefinitely retry. Defaults to 0.</span>
<span class="sd">            **kwargs: Keywords arguments for the request.</span>

<span class="sd">        Raises:</span>
<span class="sd">            asyncio.TimeoutError: Error raised if no response is received within</span>
<span class="sd">                the given timeout.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Any: The response for the request.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">gibbs_timeout</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">gibbs_retries</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Request failed : no response received within </span><span class="si">{</span><span class="n">gibbs_timeout</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
                <span class="k">raise</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">retries_left</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">gibbs_retries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Request failed : no response received within </span><span class="si">{</span><span class="n">gibbs_timeout</span><span class="si">}</span><span class="s2">s. Retrying </span><span class="si">{</span><span class="n">retries_left</span><span class="si">}</span><span class="s2"> times&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">gibbs_timeout</span><span class="o">=</span><span class="n">gibbs_timeout</span><span class="p">,</span> <span class="n">gibbs_retries</span><span class="o">=</span><span class="n">retries_left</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="gibbs.hub.Hub.receive_loop" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">receive_loop</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Infinite loop for receiving responses from the workers.</p>

            <details class="quote">
              <summary>Source code in <code>gibbs/hub.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">receive_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Infinite loop for receiving responses from the workers.&quot;&quot;&quot;</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># Receive stuff</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Receiving...&quot;</span><span class="p">)</span>
        <span class="n">address</span><span class="p">,</span> <span class="o">*</span><span class="n">frames</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">recv_multipart</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received something from worker #</span><span class="si">{</span><span class="n">address</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Since we received a response from this worker, it means it&#39;s ready for more !</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_manager</span><span class="o">.</span><span class="n">reckon</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">frames</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Answer the Ping</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Answering the ping&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">send_multipart</span><span class="p">([</span><span class="n">address</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">PONG</span><span class="p">])</span>
            <span class="k">continue</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">resp</span> <span class="o">=</span> <span class="n">frames</span>
        <span class="n">req_id</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">res</span> <span class="o">=</span> <span class="n">msgpack</span><span class="o">.</span><span class="n">unpackb</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received response from request #</span><span class="si">{</span><span class="n">req_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">req_manager</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">req_id</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="gibbs.hub.Hub.request" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">request</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">gibbs_timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gibbs_retries</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Main method, used to send a request to workers and get the result.</p>
<p>This method is a wrapper around <code>_request</code>, providing additional
functionalities :
 * Timeout
 * Automatic retries</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>*args</code></td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Positional arguments for the request.</p>
              </div>
            </td>
            <td>
                  <code>()</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>gibbs_timeout</code></td>
            <td>
                  <code>float</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Timeout for the request, in seconds.
If <code>None</code> is given, block until the request is complete.
Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>gibbs_retries</code></td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of retries. This argument is
used only if <code>gibbs_timeout</code> is not <code>None</code>. If <code>-1</code> is given,
indefinitely retry. Defaults to 0.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>**kwargs</code></td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Keywords arguments for the request.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="asyncio.TimeoutError">TimeoutError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Error raised if no response is received within
the given timeout.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>Any</code></td>            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The response for the request.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>gibbs/hub.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">gibbs_timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">gibbs_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Main method, used to send a request to workers and get the result.</span>

<span class="sd">    This method is a wrapper around `_request`, providing additional</span>
<span class="sd">    functionalities :</span>
<span class="sd">     * Timeout</span>
<span class="sd">     * Automatic retries</span>

<span class="sd">    Args:</span>
<span class="sd">        *args: Positional arguments for the request.</span>
<span class="sd">        gibbs_timeout (float): Timeout for the request, in seconds.</span>
<span class="sd">            If `None` is given, block until the request is complete.</span>
<span class="sd">            Defaults to None.</span>
<span class="sd">        gibbs_retries (int): Number of retries. This argument is</span>
<span class="sd">            used only if `gibbs_timeout` is not `None`. If `-1` is given,</span>
<span class="sd">            indefinitely retry. Defaults to 0.</span>
<span class="sd">        **kwargs: Keywords arguments for the request.</span>

<span class="sd">    Raises:</span>
<span class="sd">        asyncio.TimeoutError: Error raised if no response is received within</span>
<span class="sd">            the given timeout.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Any: The response for the request.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">gibbs_timeout</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">gibbs_retries</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Request failed : no response received within </span><span class="si">{</span><span class="n">gibbs_timeout</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">retries_left</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">gibbs_retries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Request failed : no response received within </span><span class="si">{</span><span class="n">gibbs_timeout</span><span class="si">}</span><span class="s2">s. Retrying </span><span class="si">{</span><span class="n">retries_left</span><span class="si">}</span><span class="s2"> times&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">gibbs_timeout</span><span class="o">=</span><span class="n">gibbs_timeout</span><span class="p">,</span> <span class="n">gibbs_retries</span><span class="o">=</span><span class="n">retries_left</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="gibbs.hub.RequestManager" class="doc doc-heading">
            <code>RequestManager</code>


</h2>


    <div class="doc doc-contents ">


        <p>A helper class that takes care of storing responses and waiting for the
right response.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>resp_buffer_size</code></td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum size of the response buffer.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>gibbs/hub.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">RequestManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A helper class that takes care of storing responses and waiting for the</span>
<span class="sd">    right response.</span>

<span class="sd">    Args:</span>
<span class="sd">        resp_buffer_size (int): Maximum size of the response buffer.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resp_buffer_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">resp_buffer_size</span> <span class="o">=</span> <span class="n">resp_buffer_size</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">responses</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">req_states</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">pin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pin a request ID. This is a necessary step when sending a request,</span>
<span class="sd">        so that the request can be awaited until a response is received.</span>
<span class="sd">        This method should be called for each `req_id` before calling `wait_for`.</span>

<span class="sd">        Args:</span>
<span class="sd">            req_id (str): Request unique identifier.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">req_states</span><span class="p">[</span><span class="n">req_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>

        <span class="c1"># Ensure we don&#39;t store too many requests</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">req_states</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">resp_buffer_size</span><span class="p">:</span>
            <span class="c1"># If it&#39;s the case, forget the oldest one</span>
            <span class="n">k</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">req_states</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Response buffer overflow (&gt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">resp_buffer_size</span><span class="si">}</span><span class="s2">). Forgetting oldest request : </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">req_states</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">responses</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">wait_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Async method that waits until we received the response corresponding</span>
<span class="sd">        to the given request ID.</span>

<span class="sd">        The method `pin` should be called before waiting with this method.</span>

<span class="sd">        Args:</span>
<span class="sd">            req_id (str): Request unique identifier.</span>

<span class="sd">        Raises:</span>
<span class="sd">            KeyError: Exception raised if the request wasn&#39;t registered previously.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[int, Any]: Code and content of the received response.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">req_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">req_states</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Request #</span><span class="si">{</span><span class="n">req_id</span><span class="si">}</span><span class="s2"> was not pinned, or was removed because of buffer overflow&quot;</span><span class="p">)</span>

        <span class="c1"># Wait for the receiving loop to receive the response</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">req_states</span><span class="p">[</span><span class="n">req_id</span><span class="p">]</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

        <span class="c1"># Once we get it, access the result</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">responses</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">req_id</span><span class="p">)</span>

        <span class="c1"># Don&#39;t forget to remove the event</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">req_states</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">req_id</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">content</span>

    <span class="k">def</span> <span class="nf">store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Store a response, to be consumed later.</span>

<span class="sd">        Args:</span>
<span class="sd">            req_id (str): Request unique identifier.</span>
<span class="sd">            code (int): Code of the response.</span>
<span class="sd">            response (Any): Content of the response.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Store the response if the req_id is recognized</span>
        <span class="k">if</span> <span class="n">req_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">req_states</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">responses</span><span class="p">[</span><span class="n">req_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">Response</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>

            <span class="c1"># Notify that we received the response</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">req_states</span><span class="p">[</span><span class="n">req_id</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Request #</span><span class="si">{</span><span class="n">req_id</span><span class="si">}</span><span class="s2"> was previously removed from response buffer. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Ignoring the response from this request...&quot;</span>
            <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="gibbs.hub.RequestManager.pin" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">pin</span><span class="p">(</span><span class="n">req_id</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Pin a request ID. This is a necessary step when sending a request,
so that the request can be awaited until a response is received.
This method should be called for each <code>req_id</code> before calling <code>wait_for</code>.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>req_id</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Request unique identifier.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>gibbs/hub.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">pin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Pin a request ID. This is a necessary step when sending a request,</span>
<span class="sd">    so that the request can be awaited until a response is received.</span>
<span class="sd">    This method should be called for each `req_id` before calling `wait_for`.</span>

<span class="sd">    Args:</span>
<span class="sd">        req_id (str): Request unique identifier.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">req_states</span><span class="p">[</span><span class="n">req_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>

    <span class="c1"># Ensure we don&#39;t store too many requests</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">req_states</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">resp_buffer_size</span><span class="p">:</span>
        <span class="c1"># If it&#39;s the case, forget the oldest one</span>
        <span class="n">k</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">req_states</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Response buffer overflow (&gt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">resp_buffer_size</span><span class="si">}</span><span class="s2">). Forgetting oldest request : </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">req_states</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">responses</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="gibbs.hub.RequestManager.store" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">store</span><span class="p">(</span><span class="n">req_id</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Store a response, to be consumed later.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>req_id</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Request unique identifier.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>code</code></td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Code of the response.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>response</code></td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Content of the response.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>gibbs/hub.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Store a response, to be consumed later.</span>

<span class="sd">    Args:</span>
<span class="sd">        req_id (str): Request unique identifier.</span>
<span class="sd">        code (int): Code of the response.</span>
<span class="sd">        response (Any): Content of the response.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Store the response if the req_id is recognized</span>
    <span class="k">if</span> <span class="n">req_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">req_states</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">responses</span><span class="p">[</span><span class="n">req_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">Response</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>

        <span class="c1"># Notify that we received the response</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">req_states</span><span class="p">[</span><span class="n">req_id</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Request #</span><span class="si">{</span><span class="n">req_id</span><span class="si">}</span><span class="s2"> was previously removed from response buffer. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Ignoring the response from this request...&quot;</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="gibbs.hub.RequestManager.wait_for" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">wait_for</span><span class="p">(</span><span class="n">req_id</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Async method that waits until we received the response corresponding
to the given request ID.</p>
<p>The method <code>pin</code> should be called before waiting with this method.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>req_id</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Request unique identifier.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>KeyError</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Exception raised if the request wasn't registered previously.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[int, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tuple[int, Any]: Code and content of the received response.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>gibbs/hub.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">wait_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Async method that waits until we received the response corresponding</span>
<span class="sd">    to the given request ID.</span>

<span class="sd">    The method `pin` should be called before waiting with this method.</span>

<span class="sd">    Args:</span>
<span class="sd">        req_id (str): Request unique identifier.</span>

<span class="sd">    Raises:</span>
<span class="sd">        KeyError: Exception raised if the request wasn&#39;t registered previously.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple[int, Any]: Code and content of the received response.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">req_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">req_states</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Request #</span><span class="si">{</span><span class="n">req_id</span><span class="si">}</span><span class="s2"> was not pinned, or was removed because of buffer overflow&quot;</span><span class="p">)</span>

    <span class="c1"># Wait for the receiving loop to receive the response</span>
    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">req_states</span><span class="p">[</span><span class="n">req_id</span><span class="p">]</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

    <span class="c1"># Once we get it, access the result</span>
    <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">responses</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">req_id</span><span class="p">)</span>

    <span class="c1"># Don&#39;t forget to remove the event</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">req_states</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">req_id</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">content</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="gibbs.hub.UserCodeException" class="doc doc-heading">
            <code>UserCodeException</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code>Exception</code></p>


        <p>Custom Exception for user-defined catched errors.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>t</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Traceback returned by the worker.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>gibbs/hub.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">UserCodeException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Custom Exception for user-defined catched errors.</span>

<span class="sd">    Args:</span>
<span class="sd">        t (str): Traceback returned by the worker.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exception raised in user-defined code. Traceback :</span><span class="se">\n</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="gibbs.hub.WorkerManager" class="doc doc-heading">
            <code>WorkerManager</code>


</h2>


    <div class="doc doc-contents ">


        <p>A helper class that takes care of managing workers.
Workers' address can be registered as available, and this class will make
sure to return address of workers that are available and alive.</p>
<p>A worker is considered as dead if we didn't receive any heartbeat within a
given interval.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>heartbeat_interval</code></td>
            <td>
                  <code>float</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Interval of time (in seconds) after which we
consider a worker to be dead.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>gibbs/hub.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">WorkerManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A helper class that takes care of managing workers.</span>
<span class="sd">    Workers&#39; address can be registered as available, and this class will make</span>
<span class="sd">    sure to return address of workers that are available and alive.</span>

<span class="sd">    A worker is considered as dead if we didn&#39;t receive any heartbeat within a</span>
<span class="sd">    given interval.</span>

<span class="sd">    Args:</span>
<span class="sd">        heartbeat_interval (float): Interval of time (in seconds) after which we</span>
<span class="sd">            consider a worker to be dead.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">heartbeat_interval</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">heartbeat_t</span> <span class="o">=</span> <span class="n">heartbeat_interval</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">w_ts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_access</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Condition</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">reckon</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Register the given address as available.</span>

<span class="sd">        Args:</span>
<span class="sd">            address (str): Address of the worker to register as available.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_access</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">w_ts</span><span class="p">[</span><span class="n">address</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">w_access</span><span class="o">.</span><span class="n">notify</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_next_worker</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve the next available and alive worker&#39;s address.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: Address of the available and alive worker.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_access</span><span class="p">:</span>
            <span class="c1"># Iterate workers until we find one that was alive recently</span>
            <span class="n">w_alive</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">w_alive</span><span class="p">:</span>
                <span class="c1"># If no workers are available, wait...</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_ts</span><span class="p">:</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_access</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

                <span class="n">address</span><span class="p">,</span> <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_ts</span><span class="o">.</span><span class="n">popitem</span><span class="p">()</span>
                <span class="n">w_alive</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">ts</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">heartbeat_t</span>

            <span class="k">return</span> <span class="n">address</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="gibbs.hub.WorkerManager.get_next_worker" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_next_worker</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Retrieve the next available and alive worker's address.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>str</code></td>            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Address of the available and alive worker.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>gibbs/hub.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">get_next_worker</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieve the next available and alive worker&#39;s address.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: Address of the available and alive worker.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_access</span><span class="p">:</span>
        <span class="c1"># Iterate workers until we find one that was alive recently</span>
        <span class="n">w_alive</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">w_alive</span><span class="p">:</span>
            <span class="c1"># If no workers are available, wait...</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_ts</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_access</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

            <span class="n">address</span><span class="p">,</span> <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_ts</span><span class="o">.</span><span class="n">popitem</span><span class="p">()</span>
            <span class="n">w_alive</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">ts</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">heartbeat_t</span>

        <span class="k">return</span> <span class="n">address</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="gibbs.hub.WorkerManager.reckon" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">reckon</span><span class="p">(</span><span class="n">address</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Register the given address as available.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>address</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Address of the worker to register as available.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>gibbs/hub.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">reckon</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Register the given address as available.</span>

<span class="sd">    Args:</span>
<span class="sd">        address (str): Address of the worker to register as available.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_access</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_ts</span><span class="p">[</span><span class="n">address</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_access</span><span class="o">.</span><span class="n">notify</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<a id="gibbs.worker"></a>
    <div class="doc doc-contents first">



  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="gibbs.worker.Worker" class="doc doc-heading">
            <code>Worker</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="multiprocessing.Process">Process</span></code></p>


        <p>Define a worker process. This worker process indefinitely waits for
requests on a socket. Upon receiving a request, it processes it with the
worker class provided, and return the response.</p>
<p>After creating the Worker object, you have 2 different ways to run it :
 * <code>worker.run()</code> : It will run in the current process directly (blocking,
    infinite loop).
 * <code>worker.start()</code> : It will start a different process and start the code
    there (non-blocking).</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>worker_cls</code></td>
            <td>
                  <code><span title="typing.Callable">Callable</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Worker class containing the code that will be used
to process requests.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>gibbs_host</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Host of the Hub. Defaults to "localhost".</p>
              </div>
            </td>
            <td>
                  <code>&#39;localhost&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>gibbs_port</code></td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Port of the Hub. Defaults to DEFAULT_PORT.</p>
              </div>
            </td>
            <td>
                  <code><span title="gibbs.worker.DEFAULT_PORT">DEFAULT_PORT</span></code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>gibbs_heartbeat_interval</code></td>
            <td>
                  <code>float</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Heartbeat interval between the
worker and the Hub. Defaults to DEFAULT_HEARTBEAT_INTERVAL.</p>
              </div>
            </td>
            <td>
                  <code><span title="gibbs.worker.DEFAULT_HEARTBEAT_INTERVAL">DEFAULT_HEARTBEAT_INTERVAL</span></code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>gibbs_reset_after_n_miss</code></td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of missed heartbeats
allowed before hard-resetting the socket and retrying. Defaults to
DEFAULT_RESET_AFTER_N_MISS.</p>
              </div>
            </td>
            <td>
                  <code><span title="gibbs.worker.DEFAULT_RESET_AFTER_N_MISS">DEFAULT_RESET_AFTER_N_MISS</span></code>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>gibbs/worker.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Worker</span><span class="p">(</span><span class="n">Process</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Define a worker process. This worker process indefinitely waits for</span>
<span class="sd">    requests on a socket. Upon receiving a request, it processes it with the</span>
<span class="sd">    worker class provided, and return the response.</span>

<span class="sd">    After creating the Worker object, you have 2 different ways to run it :</span>
<span class="sd">     * `worker.run()` : It will run in the current process directly (blocking,</span>
<span class="sd">        infinite loop).</span>
<span class="sd">     * `worker.start()` : It will start a different process and start the code</span>
<span class="sd">        there (non-blocking).</span>

<span class="sd">    Args:</span>
<span class="sd">        worker_cls (Callable): Worker class containing the code that will be used</span>
<span class="sd">            to process requests.</span>
<span class="sd">        gibbs_host (str): Host of the Hub. Defaults to &quot;localhost&quot;.</span>
<span class="sd">        gibbs_port (int): Port of the Hub. Defaults to DEFAULT_PORT.</span>
<span class="sd">        gibbs_heartbeat_interval (float): Heartbeat interval between the</span>
<span class="sd">            worker and the Hub. Defaults to DEFAULT_HEARTBEAT_INTERVAL.</span>
<span class="sd">        gibbs_reset_after_n_miss (int): Number of missed heartbeats</span>
<span class="sd">            allowed before hard-resetting the socket and retrying. Defaults to</span>
<span class="sd">            DEFAULT_RESET_AFTER_N_MISS.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">worker_cls</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="n">gibbs_host</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;localhost&quot;</span><span class="p">,</span>
        <span class="n">gibbs_port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_PORT</span><span class="p">,</span>
        <span class="n">gibbs_heartbeat_interval</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">DEFAULT_HEARTBEAT_INTERVAL</span><span class="p">,</span>
        <span class="n">gibbs_reset_after_n_miss</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_RESET_AFTER_N_MISS</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">worker_cls</span> <span class="o">=</span> <span class="n">worker_cls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker_args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">identity</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">gibbs_host</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">gibbs_port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">heartbeat_t</span> <span class="o">=</span> <span class="n">gibbs_heartbeat_interval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_n_miss</span> <span class="o">=</span> <span class="n">gibbs_reset_after_n_miss</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">waiting_pong</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">create_socket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Context</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Socket</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper method to create a socket, setting its identity and connecting</span>
<span class="sd">        to the Hub.</span>

<span class="sd">        Args:</span>
<span class="sd">            context (zmq.Context): ZMQ context to use.</span>

<span class="sd">        Returns:</span>
<span class="sd">            zmq.Socket: Initialized and connected socket, ready to use.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create the socket, set its identity</span>
        <span class="n">socket</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">DEALER</span><span class="p">)</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">setsockopt_string</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">IDENTITY</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">identity</span><span class="p">)</span>

        <span class="c1"># Connect to the Hub</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tcp://</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">socket</span>

    <span class="k">def</span> <span class="nf">create_term_socket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Context</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Socket</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper method to create a termination socket.</span>

<span class="sd">        Basically it creates 2 sockets, bind/connect them together. One socket</span>
<span class="sd">        will be used to send a termination signal, and the other is returned and</span>
<span class="sd">        used to receive the termination signal.</span>

<span class="sd">        Args:</span>
<span class="sd">            context (zmq.Context): ZMQ context to use.</span>

<span class="sd">        Returns:</span>
<span class="sd">            zmq.Socket: Initialized and connected socket, ready to use.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create the socket than will send the termination ping</span>
        <span class="n">term_snd_socket</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">REQ</span><span class="p">)</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">term_snd_socket</span><span class="o">.</span><span class="n">bind_to_random_port</span><span class="p">(</span><span class="s2">&quot;tcp://127.0.0.1&quot;</span><span class="p">)</span>

        <span class="c1"># Then define the behavior on how to send the termination ping</span>
        <span class="k">def</span> <span class="nf">send_term</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Sending termination ping...&quot;</span><span class="p">)</span>
            <span class="c1"># Send something on the termination socket, it doesn&#39;t matter what</span>
            <span class="n">term_snd_socket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">PING</span><span class="p">)</span>

        <span class="c1"># We send the termination ping upon receiving these signals</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="n">send_term</span><span class="p">)</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">send_term</span><span class="p">)</span>

        <span class="c1"># And finally create the socket that we will use to receive the termination signal</span>
        <span class="n">term_rcv_socket</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">REP</span><span class="p">)</span>
        <span class="n">term_rcv_socket</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tcp://localhost:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">term_rcv_socket</span>

    <span class="k">def</span> <span class="nf">reset_socket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">socket</span><span class="p">:</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Socket</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">poller</span><span class="p">:</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Poller</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Socket</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper method to reset the given socket.</span>

<span class="sd">        This method unregister the socket from the given poller, close the</span>
<span class="sd">        socket, and then recreate the socket and register this new socket in the</span>
<span class="sd">        poller.</span>

<span class="sd">        Args:</span>
<span class="sd">            socket (zmq.Socket): ZMQ socket to reset.</span>
<span class="sd">            context (zmq.Context): ZMQ context to use.</span>
<span class="sd">            poller (zmq.Poller): ZMQ poller where the socket is registered.</span>

<span class="sd">        Returns:</span>
<span class="sd">            zmq.Socket: Initialized and connected socket, ready to use.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Close the existing socket</span>
        <span class="n">poller</span><span class="o">.</span><span class="n">unregister</span><span class="p">(</span><span class="n">socket</span><span class="p">)</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">linger</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Recreate the socket</span>
        <span class="n">socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_socket</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="n">poller</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">zmq</span><span class="o">.</span><span class="n">POLLIN</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">socket</span>

    <span class="k">def</span> <span class="nf">ping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">socket</span><span class="p">:</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Socket</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper method used for the heartbeat. Also takes care of keeping the</span>
<span class="sd">        counter of heartbeats up-to-date.</span>

<span class="sd">        Args:</span>
<span class="sd">            socket (zmq.Socket): Socket to use to send the heartbeat.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Sending ping...&quot;</span><span class="p">)</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">PING</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">waiting_pong</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Main method. It will initialize the worker class, and enter an</span>
<span class="sd">        infinite loop, waiting for requests. Whenever a request is received, it</span>
<span class="sd">        processes it with the code provided in the constructor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Instanciate the worker</span>
        <span class="n">worker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_cls</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">worker_args</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">worker_kwargs</span><span class="p">)</span>

        <span class="c1"># Initialize what we need for handling sockets</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Context</span><span class="p">()</span>
        <span class="n">poller</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Poller</span><span class="p">()</span>

        <span class="c1"># Create the socket for termination</span>
        <span class="n">term_socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_term_socket</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="n">poller</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">term_socket</span><span class="p">,</span> <span class="n">zmq</span><span class="o">.</span><span class="n">POLLIN</span><span class="p">)</span>

        <span class="c1"># Create the socket connecting to the hub</span>
        <span class="n">socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_socket</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="n">poller</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">zmq</span><span class="o">.</span><span class="n">POLLIN</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Worker ready to roll&quot;</span><span class="p">)</span>

        <span class="c1"># Tell the Hub we are ready</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ping</span><span class="p">(</span><span class="n">socket</span><span class="p">)</span>

        <span class="c1"># Indefinitely wait for requests : when we are done with one request,</span>
        <span class="c1"># we wait for the next one</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Waiting for request...&quot;</span><span class="p">)</span>
            <span class="n">events</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">poller</span><span class="o">.</span><span class="n">poll</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">heartbeat_t</span> <span class="o">*</span> <span class="n">MS</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">term_socket</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Termination signal received, shutting down gracefully&quot;</span><span class="p">)</span>
                <span class="k">break</span>

            <span class="k">if</span> <span class="n">socket</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">workload</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">recv_multipart</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">NOBLOCK</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Received something !&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">waiting_pong</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Didn&#39;t receive anything for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">heartbeat_t</span><span class="si">}</span><span class="s2">s (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">waiting_pong</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">waiting_pong</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_n_miss</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;The Hub is not answering, even after </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">waiting_pong</span><span class="si">}</span><span class="s2"> missed pings... &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;Resetting the socket&quot;</span>
                    <span class="p">)</span>
                    <span class="n">socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_socket</span><span class="p">(</span><span class="n">socket</span><span class="o">=</span><span class="n">socket</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span> <span class="n">poller</span><span class="o">=</span><span class="n">poller</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">waiting_pong</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="c1"># We didn&#39;t receive anything for some time, try to ping again</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ping</span><span class="p">(</span><span class="n">socket</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">workload</span> <span class="o">==</span> <span class="n">PONG</span><span class="p">:</span>
                <span class="c1"># Just a Pong, ignore it</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;It was just a pong...&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># From here the Hub sent us an actual request</span>
            <span class="n">req_id</span><span class="p">,</span> <span class="n">req_args</span><span class="p">,</span> <span class="n">req_kwargs</span> <span class="o">=</span> <span class="n">msgpack</span><span class="o">.</span><span class="n">unpackb</span><span class="p">(</span><span class="n">workload</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Request #</span><span class="si">{</span><span class="n">req_id</span><span class="si">}</span><span class="s2"> received&quot;</span><span class="p">)</span>

            <span class="c1"># Call worker&#39;s code with the request arguments</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">worker</span><span class="p">(</span><span class="o">*</span><span class="n">req_args</span><span class="p">,</span> <span class="o">**</span><span class="n">req_kwargs</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exception in user-defined __call__ method : </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                <span class="n">socket</span><span class="o">.</span><span class="n">send_multipart</span><span class="p">([</span><span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">msgpack</span><span class="o">.</span><span class="n">packb</span><span class="p">([</span><span class="n">req_id</span><span class="p">,</span> <span class="n">CODE_FAILURE</span><span class="p">,</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()])])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Sending back the response&quot;</span><span class="p">)</span>
                <span class="n">socket</span><span class="o">.</span><span class="n">send_multipart</span><span class="p">([</span><span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">msgpack</span><span class="o">.</span><span class="n">packb</span><span class="p">([</span><span class="n">req_id</span><span class="p">,</span> <span class="n">CODE_SUCCESS</span><span class="p">,</span> <span class="n">res</span><span class="p">])])</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Worker is shut down&quot;</span><span class="p">)</span>
        <span class="n">quit</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="gibbs.worker.Worker.create_socket" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_socket</span><span class="p">(</span><span class="n">context</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Helper method to create a socket, setting its identity and connecting
to the Hub.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>context</code></td>
            <td>
                  <code><span title="zmq.Context">Context</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ZMQ context to use.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="zmq.Socket">Socket</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>zmq.Socket: Initialized and connected socket, ready to use.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>gibbs/worker.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">create_socket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Context</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Socket</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper method to create a socket, setting its identity and connecting</span>
<span class="sd">    to the Hub.</span>

<span class="sd">    Args:</span>
<span class="sd">        context (zmq.Context): ZMQ context to use.</span>

<span class="sd">    Returns:</span>
<span class="sd">        zmq.Socket: Initialized and connected socket, ready to use.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create the socket, set its identity</span>
    <span class="n">socket</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">DEALER</span><span class="p">)</span>
    <span class="n">socket</span><span class="o">.</span><span class="n">setsockopt_string</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">IDENTITY</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">identity</span><span class="p">)</span>

    <span class="c1"># Connect to the Hub</span>
    <span class="n">socket</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tcp://</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">socket</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="gibbs.worker.Worker.create_term_socket" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_term_socket</span><span class="p">(</span><span class="n">context</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Helper method to create a termination socket.</p>
<p>Basically it creates 2 sockets, bind/connect them together. One socket
will be used to send a termination signal, and the other is returned and
used to receive the termination signal.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>context</code></td>
            <td>
                  <code><span title="zmq.Context">Context</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ZMQ context to use.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="zmq.Socket">Socket</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>zmq.Socket: Initialized and connected socket, ready to use.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>gibbs/worker.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">create_term_socket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Context</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Socket</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper method to create a termination socket.</span>

<span class="sd">    Basically it creates 2 sockets, bind/connect them together. One socket</span>
<span class="sd">    will be used to send a termination signal, and the other is returned and</span>
<span class="sd">    used to receive the termination signal.</span>

<span class="sd">    Args:</span>
<span class="sd">        context (zmq.Context): ZMQ context to use.</span>

<span class="sd">    Returns:</span>
<span class="sd">        zmq.Socket: Initialized and connected socket, ready to use.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create the socket than will send the termination ping</span>
    <span class="n">term_snd_socket</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">REQ</span><span class="p">)</span>
    <span class="n">port</span> <span class="o">=</span> <span class="n">term_snd_socket</span><span class="o">.</span><span class="n">bind_to_random_port</span><span class="p">(</span><span class="s2">&quot;tcp://127.0.0.1&quot;</span><span class="p">)</span>

    <span class="c1"># Then define the behavior on how to send the termination ping</span>
    <span class="k">def</span> <span class="nf">send_term</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Sending termination ping...&quot;</span><span class="p">)</span>
        <span class="c1"># Send something on the termination socket, it doesn&#39;t matter what</span>
        <span class="n">term_snd_socket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">PING</span><span class="p">)</span>

    <span class="c1"># We send the termination ping upon receiving these signals</span>
    <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="n">send_term</span><span class="p">)</span>
    <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">send_term</span><span class="p">)</span>

    <span class="c1"># And finally create the socket that we will use to receive the termination signal</span>
    <span class="n">term_rcv_socket</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">REP</span><span class="p">)</span>
    <span class="n">term_rcv_socket</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tcp://localhost:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">term_rcv_socket</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="gibbs.worker.Worker.ping" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">ping</span><span class="p">(</span><span class="n">socket</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Helper method used for the heartbeat. Also takes care of keeping the
counter of heartbeats up-to-date.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>socket</code></td>
            <td>
                  <code><span title="zmq.Socket">Socket</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Socket to use to send the heartbeat.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>gibbs/worker.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">ping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">socket</span><span class="p">:</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Socket</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper method used for the heartbeat. Also takes care of keeping the</span>
<span class="sd">    counter of heartbeats up-to-date.</span>

<span class="sd">    Args:</span>
<span class="sd">        socket (zmq.Socket): Socket to use to send the heartbeat.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Sending ping...&quot;</span><span class="p">)</span>
    <span class="n">socket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">PING</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">waiting_pong</span> <span class="o">+=</span> <span class="mi">1</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="gibbs.worker.Worker.reset_socket" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">reset_socket</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">poller</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Helper method to reset the given socket.</p>
<p>This method unregister the socket from the given poller, close the
socket, and then recreate the socket and register this new socket in the
poller.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>socket</code></td>
            <td>
                  <code><span title="zmq.Socket">Socket</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ZMQ socket to reset.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>context</code></td>
            <td>
                  <code><span title="zmq.Context">Context</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ZMQ context to use.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>poller</code></td>
            <td>
                  <code><span title="zmq.Poller">Poller</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ZMQ poller where the socket is registered.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="zmq.Socket">Socket</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>zmq.Socket: Initialized and connected socket, ready to use.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>gibbs/worker.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">reset_socket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">socket</span><span class="p">:</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Socket</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">poller</span><span class="p">:</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Poller</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Socket</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper method to reset the given socket.</span>

<span class="sd">    This method unregister the socket from the given poller, close the</span>
<span class="sd">    socket, and then recreate the socket and register this new socket in the</span>
<span class="sd">    poller.</span>

<span class="sd">    Args:</span>
<span class="sd">        socket (zmq.Socket): ZMQ socket to reset.</span>
<span class="sd">        context (zmq.Context): ZMQ context to use.</span>
<span class="sd">        poller (zmq.Poller): ZMQ poller where the socket is registered.</span>

<span class="sd">    Returns:</span>
<span class="sd">        zmq.Socket: Initialized and connected socket, ready to use.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Close the existing socket</span>
    <span class="n">poller</span><span class="o">.</span><span class="n">unregister</span><span class="p">(</span><span class="n">socket</span><span class="p">)</span>
    <span class="n">socket</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">linger</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Recreate the socket</span>
    <span class="n">socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_socket</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
    <span class="n">poller</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">zmq</span><span class="o">.</span><span class="n">POLLIN</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">socket</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="gibbs.worker.Worker.run" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">run</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Main method. It will initialize the worker class, and enter an
infinite loop, waiting for requests. Whenever a request is received, it
processes it with the code provided in the constructor.</p>

            <details class="quote">
              <summary>Source code in <code>gibbs/worker.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Main method. It will initialize the worker class, and enter an</span>
<span class="sd">    infinite loop, waiting for requests. Whenever a request is received, it</span>
<span class="sd">    processes it with the code provided in the constructor.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Instanciate the worker</span>
    <span class="n">worker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_cls</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">worker_args</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">worker_kwargs</span><span class="p">)</span>

    <span class="c1"># Initialize what we need for handling sockets</span>
    <span class="n">context</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Context</span><span class="p">()</span>
    <span class="n">poller</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Poller</span><span class="p">()</span>

    <span class="c1"># Create the socket for termination</span>
    <span class="n">term_socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_term_socket</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
    <span class="n">poller</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">term_socket</span><span class="p">,</span> <span class="n">zmq</span><span class="o">.</span><span class="n">POLLIN</span><span class="p">)</span>

    <span class="c1"># Create the socket connecting to the hub</span>
    <span class="n">socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_socket</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
    <span class="n">poller</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">zmq</span><span class="o">.</span><span class="n">POLLIN</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Worker ready to roll&quot;</span><span class="p">)</span>

    <span class="c1"># Tell the Hub we are ready</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ping</span><span class="p">(</span><span class="n">socket</span><span class="p">)</span>

    <span class="c1"># Indefinitely wait for requests : when we are done with one request,</span>
    <span class="c1"># we wait for the next one</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Waiting for request...&quot;</span><span class="p">)</span>
        <span class="n">events</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">poller</span><span class="o">.</span><span class="n">poll</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">heartbeat_t</span> <span class="o">*</span> <span class="n">MS</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">term_socket</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Termination signal received, shutting down gracefully&quot;</span><span class="p">)</span>
            <span class="k">break</span>

        <span class="k">if</span> <span class="n">socket</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">workload</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">recv_multipart</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">NOBLOCK</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Received something !&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">waiting_pong</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Didn&#39;t receive anything for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">heartbeat_t</span><span class="si">}</span><span class="s2">s (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">waiting_pong</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">waiting_pong</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_n_miss</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The Hub is not answering, even after </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">waiting_pong</span><span class="si">}</span><span class="s2"> missed pings... &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Resetting the socket&quot;</span>
                <span class="p">)</span>
                <span class="n">socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_socket</span><span class="p">(</span><span class="n">socket</span><span class="o">=</span><span class="n">socket</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span> <span class="n">poller</span><span class="o">=</span><span class="n">poller</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">waiting_pong</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># We didn&#39;t receive anything for some time, try to ping again</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ping</span><span class="p">(</span><span class="n">socket</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">workload</span> <span class="o">==</span> <span class="n">PONG</span><span class="p">:</span>
            <span class="c1"># Just a Pong, ignore it</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;It was just a pong...&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># From here the Hub sent us an actual request</span>
        <span class="n">req_id</span><span class="p">,</span> <span class="n">req_args</span><span class="p">,</span> <span class="n">req_kwargs</span> <span class="o">=</span> <span class="n">msgpack</span><span class="o">.</span><span class="n">unpackb</span><span class="p">(</span><span class="n">workload</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Request #</span><span class="si">{</span><span class="n">req_id</span><span class="si">}</span><span class="s2"> received&quot;</span><span class="p">)</span>

        <span class="c1"># Call worker&#39;s code with the request arguments</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">worker</span><span class="p">(</span><span class="o">*</span><span class="n">req_args</span><span class="p">,</span> <span class="o">**</span><span class="n">req_kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exception in user-defined __call__ method : </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="n">socket</span><span class="o">.</span><span class="n">send_multipart</span><span class="p">([</span><span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">msgpack</span><span class="o">.</span><span class="n">packb</span><span class="p">([</span><span class="n">req_id</span><span class="p">,</span> <span class="n">CODE_FAILURE</span><span class="p">,</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()])])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Sending back the response&quot;</span><span class="p">)</span>
            <span class="n">socket</span><span class="o">.</span><span class="n">send_multipart</span><span class="p">([</span><span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">msgpack</span><span class="o">.</span><span class="n">packb</span><span class="p">([</span><span class="n">req_id</span><span class="p">,</span> <span class="n">CODE_SUCCESS</span><span class="p">,</span> <span class="n">res</span><span class="p">])])</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Worker is shut down&quot;</span><span class="p">)</span>
    <span class="n">quit</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div><h2 id="internal">Internal</h2>


<div class="doc doc-object doc-module">



<a id="gibbs.hub"></a>
    <div class="doc doc-contents first">



  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="gibbs.hub.Hub" class="doc doc-heading">
            <code>Hub</code>


</h2>


    <div class="doc doc-contents ">


        <p>Class acting as a hub for all the requests to send. All requests sent
through this class will be automatically dispatched to connected workers,
will wait for the responses and return it.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>port</code></td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Port number to use for the sockets. Defaults to
DEFAULT_PORT.</p>
              </div>
            </td>
            <td>
                  <code><span title="gibbs.worker.DEFAULT_PORT">DEFAULT_PORT</span></code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>heartbeat_interval</code></td>
            <td>
                  <code>float</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Heartbeat interval used by the
workers, in seconds. Defaults to DEFAULT_HEARTBEAT_INTERVAL.</p>
              </div>
            </td>
            <td>
                  <code><span title="gibbs.worker.DEFAULT_HEARTBEAT_INTERVAL">DEFAULT_HEARTBEAT_INTERVAL</span></code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>resp_buffer_size</code></td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum response buffer size. Defaults
to RESPONSE_BUFFER_SIZE.</p>
              </div>
            </td>
            <td>
                  <code><span title="gibbs.hub.RESPONSE_BUFFER_SIZE">RESPONSE_BUFFER_SIZE</span></code>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>gibbs/hub.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Hub</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Class acting as a hub for all the requests to send. All requests sent</span>
<span class="sd">    through this class will be automatically dispatched to connected workers,</span>
<span class="sd">    will wait for the responses and return it.</span>

<span class="sd">    Args:</span>
<span class="sd">        port (int): Port number to use for the sockets. Defaults to</span>
<span class="sd">            DEFAULT_PORT.</span>
<span class="sd">        heartbeat_interval (float): Heartbeat interval used by the</span>
<span class="sd">            workers, in seconds. Defaults to DEFAULT_HEARTBEAT_INTERVAL.</span>
<span class="sd">        resp_buffer_size (int): Maximum response buffer size. Defaults</span>
<span class="sd">            to RESPONSE_BUFFER_SIZE.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_PORT</span><span class="p">,</span>
        <span class="n">heartbeat_interval</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">DEFAULT_HEARTBEAT_INTERVAL</span><span class="p">,</span>
        <span class="n">resp_buffer_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">RESPONSE_BUFFER_SIZE</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">heartbeat_t</span> <span class="o">=</span> <span class="n">heartbeat_interval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_manager</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">req_manager</span> <span class="o">=</span> <span class="n">RequestManager</span><span class="p">(</span><span class="n">resp_buffer_size</span><span class="o">=</span><span class="n">resp_buffer_size</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">receive_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Infinite loop for receiving responses from the workers.&quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># Receive stuff</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Receiving...&quot;</span><span class="p">)</span>
            <span class="n">address</span><span class="p">,</span> <span class="o">*</span><span class="n">frames</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">recv_multipart</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received something from worker #</span><span class="si">{</span><span class="n">address</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Since we received a response from this worker, it means it&#39;s ready for more !</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_manager</span><span class="o">.</span><span class="n">reckon</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">frames</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Answer the Ping</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Answering the ping&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">send_multipart</span><span class="p">([</span><span class="n">address</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">PONG</span><span class="p">])</span>
                <span class="k">continue</span>

            <span class="n">_</span><span class="p">,</span> <span class="n">resp</span> <span class="o">=</span> <span class="n">frames</span>
            <span class="n">req_id</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">res</span> <span class="o">=</span> <span class="n">msgpack</span><span class="o">.</span><span class="n">unpackb</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received response from request #</span><span class="si">{</span><span class="n">req_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">req_manager</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">req_id</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_start_if_not_started</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper method to ensure everything is properly started (socket is</span>
<span class="sd">        initialized, receiving loop is started, etc...).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Create what we need here in this process/context</span>
            <span class="n">context</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">asyncio</span><span class="o">.</span><span class="n">Context</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">ROUTER</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tcp://*:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">w_manager</span> <span class="o">=</span> <span class="n">WorkerManager</span><span class="p">(</span><span class="n">heartbeat_interval</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">heartbeat_t</span><span class="p">)</span>

            <span class="c1"># Fire and forget : infinite loop, taking care of receiving stuff from the socket</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting receiving loop...&quot;</span><span class="p">)</span>
            <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">receive_loop</span><span class="p">())</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Raw method to send a request. This method will do the following :</span>
<span class="sd">         * Start the receiving loop if it was not started</span>
<span class="sd">         * Get the address of the next worker ready (blocking)</span>
<span class="sd">         * Send the request to the worker</span>
<span class="sd">         * Wait for the response (blocking)</span>
<span class="sd">         * Return the result</span>

<span class="sd">        Args:</span>
<span class="sd">            *args: Positional arguments for the request.</span>
<span class="sd">            **kwargs: Keywords arguments for the request.</span>

<span class="sd">        Raises:</span>
<span class="sd">            UserCodeException: Exception raised if an exception was raised inside</span>
<span class="sd">                user-defined code on the worker side.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Any: The response for the request.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Before anything, if the receiving loop was not started, start it</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_if_not_started</span><span class="p">()</span>

        <span class="c1"># Assign a unique ID to the request</span>
        <span class="n">req_id</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span>

        <span class="c1"># Let the manager know that we are waiting for this request</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pinning request #</span><span class="si">{</span><span class="n">req_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">req_manager</span><span class="o">.</span><span class="n">pin</span><span class="p">(</span><span class="n">req_id</span><span class="p">)</span>

        <span class="c1"># Send the request</span>
        <span class="n">address</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_manager</span><span class="o">.</span><span class="n">get_next_worker</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sending request #</span><span class="si">{</span><span class="n">req_id</span><span class="si">}</span><span class="s2"> to worker #</span><span class="si">{</span><span class="n">address</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">send_multipart</span><span class="p">([</span><span class="n">address</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">msgpack</span><span class="o">.</span><span class="n">packb</span><span class="p">([</span><span class="n">req_id</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">])])</span>

        <span class="c1"># Wait until we receive the response</span>
        <span class="n">code</span><span class="p">,</span> <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">req_manager</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span><span class="n">req_id</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received result for request #</span><span class="si">{</span><span class="n">req_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Depending on what is the response, deal with it properly</span>
        <span class="k">if</span> <span class="n">code</span> <span class="o">==</span> <span class="n">CODE_FAILURE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UserCodeException</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">res</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">gibbs_timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">gibbs_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Main method, used to send a request to workers and get the result.</span>

<span class="sd">        This method is a wrapper around `_request`, providing additional</span>
<span class="sd">        functionalities :</span>
<span class="sd">         * Timeout</span>
<span class="sd">         * Automatic retries</span>

<span class="sd">        Args:</span>
<span class="sd">            *args: Positional arguments for the request.</span>
<span class="sd">            gibbs_timeout (float): Timeout for the request, in seconds.</span>
<span class="sd">                If `None` is given, block until the request is complete.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            gibbs_retries (int): Number of retries. This argument is</span>
<span class="sd">                used only if `gibbs_timeout` is not `None`. If `-1` is given,</span>
<span class="sd">                indefinitely retry. Defaults to 0.</span>
<span class="sd">            **kwargs: Keywords arguments for the request.</span>

<span class="sd">        Raises:</span>
<span class="sd">            asyncio.TimeoutError: Error raised if no response is received within</span>
<span class="sd">                the given timeout.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Any: The response for the request.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">gibbs_timeout</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">gibbs_retries</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Request failed : no response received within </span><span class="si">{</span><span class="n">gibbs_timeout</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
                <span class="k">raise</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">retries_left</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">gibbs_retries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Request failed : no response received within </span><span class="si">{</span><span class="n">gibbs_timeout</span><span class="si">}</span><span class="s2">s. Retrying </span><span class="si">{</span><span class="n">retries_left</span><span class="si">}</span><span class="s2"> times&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">gibbs_timeout</span><span class="o">=</span><span class="n">gibbs_timeout</span><span class="p">,</span> <span class="n">gibbs_retries</span><span class="o">=</span><span class="n">retries_left</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="gibbs.hub.Hub.receive_loop" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">receive_loop</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Infinite loop for receiving responses from the workers.</p>

            <details class="quote">
              <summary>Source code in <code>gibbs/hub.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">receive_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Infinite loop for receiving responses from the workers.&quot;&quot;&quot;</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># Receive stuff</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Receiving...&quot;</span><span class="p">)</span>
        <span class="n">address</span><span class="p">,</span> <span class="o">*</span><span class="n">frames</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">recv_multipart</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received something from worker #</span><span class="si">{</span><span class="n">address</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Since we received a response from this worker, it means it&#39;s ready for more !</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_manager</span><span class="o">.</span><span class="n">reckon</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">frames</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Answer the Ping</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Answering the ping&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">send_multipart</span><span class="p">([</span><span class="n">address</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">PONG</span><span class="p">])</span>
            <span class="k">continue</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">resp</span> <span class="o">=</span> <span class="n">frames</span>
        <span class="n">req_id</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">res</span> <span class="o">=</span> <span class="n">msgpack</span><span class="o">.</span><span class="n">unpackb</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received response from request #</span><span class="si">{</span><span class="n">req_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">req_manager</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">req_id</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="gibbs.hub.Hub.request" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">request</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">gibbs_timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gibbs_retries</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Main method, used to send a request to workers and get the result.</p>
<p>This method is a wrapper around <code>_request</code>, providing additional
functionalities :
 * Timeout
 * Automatic retries</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>*args</code></td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Positional arguments for the request.</p>
              </div>
            </td>
            <td>
                  <code>()</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>gibbs_timeout</code></td>
            <td>
                  <code>float</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Timeout for the request, in seconds.
If <code>None</code> is given, block until the request is complete.
Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>gibbs_retries</code></td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of retries. This argument is
used only if <code>gibbs_timeout</code> is not <code>None</code>. If <code>-1</code> is given,
indefinitely retry. Defaults to 0.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>**kwargs</code></td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Keywords arguments for the request.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="asyncio.TimeoutError">TimeoutError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Error raised if no response is received within
the given timeout.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>Any</code></td>            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The response for the request.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>gibbs/hub.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">gibbs_timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">gibbs_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Main method, used to send a request to workers and get the result.</span>

<span class="sd">    This method is a wrapper around `_request`, providing additional</span>
<span class="sd">    functionalities :</span>
<span class="sd">     * Timeout</span>
<span class="sd">     * Automatic retries</span>

<span class="sd">    Args:</span>
<span class="sd">        *args: Positional arguments for the request.</span>
<span class="sd">        gibbs_timeout (float): Timeout for the request, in seconds.</span>
<span class="sd">            If `None` is given, block until the request is complete.</span>
<span class="sd">            Defaults to None.</span>
<span class="sd">        gibbs_retries (int): Number of retries. This argument is</span>
<span class="sd">            used only if `gibbs_timeout` is not `None`. If `-1` is given,</span>
<span class="sd">            indefinitely retry. Defaults to 0.</span>
<span class="sd">        **kwargs: Keywords arguments for the request.</span>

<span class="sd">    Raises:</span>
<span class="sd">        asyncio.TimeoutError: Error raised if no response is received within</span>
<span class="sd">            the given timeout.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Any: The response for the request.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">gibbs_timeout</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">gibbs_retries</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Request failed : no response received within </span><span class="si">{</span><span class="n">gibbs_timeout</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">retries_left</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">gibbs_retries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Request failed : no response received within </span><span class="si">{</span><span class="n">gibbs_timeout</span><span class="si">}</span><span class="s2">s. Retrying </span><span class="si">{</span><span class="n">retries_left</span><span class="si">}</span><span class="s2"> times&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">gibbs_timeout</span><span class="o">=</span><span class="n">gibbs_timeout</span><span class="p">,</span> <span class="n">gibbs_retries</span><span class="o">=</span><span class="n">retries_left</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="gibbs.hub.RequestManager" class="doc doc-heading">
            <code>RequestManager</code>


</h2>


    <div class="doc doc-contents ">


        <p>A helper class that takes care of storing responses and waiting for the
right response.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>resp_buffer_size</code></td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum size of the response buffer.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>gibbs/hub.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">RequestManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A helper class that takes care of storing responses and waiting for the</span>
<span class="sd">    right response.</span>

<span class="sd">    Args:</span>
<span class="sd">        resp_buffer_size (int): Maximum size of the response buffer.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resp_buffer_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">resp_buffer_size</span> <span class="o">=</span> <span class="n">resp_buffer_size</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">responses</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">req_states</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">pin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pin a request ID. This is a necessary step when sending a request,</span>
<span class="sd">        so that the request can be awaited until a response is received.</span>
<span class="sd">        This method should be called for each `req_id` before calling `wait_for`.</span>

<span class="sd">        Args:</span>
<span class="sd">            req_id (str): Request unique identifier.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">req_states</span><span class="p">[</span><span class="n">req_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>

        <span class="c1"># Ensure we don&#39;t store too many requests</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">req_states</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">resp_buffer_size</span><span class="p">:</span>
            <span class="c1"># If it&#39;s the case, forget the oldest one</span>
            <span class="n">k</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">req_states</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Response buffer overflow (&gt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">resp_buffer_size</span><span class="si">}</span><span class="s2">). Forgetting oldest request : </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">req_states</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">responses</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">wait_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Async method that waits until we received the response corresponding</span>
<span class="sd">        to the given request ID.</span>

<span class="sd">        The method `pin` should be called before waiting with this method.</span>

<span class="sd">        Args:</span>
<span class="sd">            req_id (str): Request unique identifier.</span>

<span class="sd">        Raises:</span>
<span class="sd">            KeyError: Exception raised if the request wasn&#39;t registered previously.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[int, Any]: Code and content of the received response.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">req_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">req_states</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Request #</span><span class="si">{</span><span class="n">req_id</span><span class="si">}</span><span class="s2"> was not pinned, or was removed because of buffer overflow&quot;</span><span class="p">)</span>

        <span class="c1"># Wait for the receiving loop to receive the response</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">req_states</span><span class="p">[</span><span class="n">req_id</span><span class="p">]</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

        <span class="c1"># Once we get it, access the result</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">responses</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">req_id</span><span class="p">)</span>

        <span class="c1"># Don&#39;t forget to remove the event</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">req_states</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">req_id</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">content</span>

    <span class="k">def</span> <span class="nf">store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Store a response, to be consumed later.</span>

<span class="sd">        Args:</span>
<span class="sd">            req_id (str): Request unique identifier.</span>
<span class="sd">            code (int): Code of the response.</span>
<span class="sd">            response (Any): Content of the response.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Store the response if the req_id is recognized</span>
        <span class="k">if</span> <span class="n">req_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">req_states</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">responses</span><span class="p">[</span><span class="n">req_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">Response</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>

            <span class="c1"># Notify that we received the response</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">req_states</span><span class="p">[</span><span class="n">req_id</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Request #</span><span class="si">{</span><span class="n">req_id</span><span class="si">}</span><span class="s2"> was previously removed from response buffer. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Ignoring the response from this request...&quot;</span>
            <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="gibbs.hub.RequestManager.pin" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">pin</span><span class="p">(</span><span class="n">req_id</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Pin a request ID. This is a necessary step when sending a request,
so that the request can be awaited until a response is received.
This method should be called for each <code>req_id</code> before calling <code>wait_for</code>.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>req_id</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Request unique identifier.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>gibbs/hub.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">pin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Pin a request ID. This is a necessary step when sending a request,</span>
<span class="sd">    so that the request can be awaited until a response is received.</span>
<span class="sd">    This method should be called for each `req_id` before calling `wait_for`.</span>

<span class="sd">    Args:</span>
<span class="sd">        req_id (str): Request unique identifier.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">req_states</span><span class="p">[</span><span class="n">req_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>

    <span class="c1"># Ensure we don&#39;t store too many requests</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">req_states</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">resp_buffer_size</span><span class="p">:</span>
        <span class="c1"># If it&#39;s the case, forget the oldest one</span>
        <span class="n">k</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">req_states</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Response buffer overflow (&gt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">resp_buffer_size</span><span class="si">}</span><span class="s2">). Forgetting oldest request : </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">req_states</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">responses</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="gibbs.hub.RequestManager.store" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">store</span><span class="p">(</span><span class="n">req_id</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Store a response, to be consumed later.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>req_id</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Request unique identifier.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>code</code></td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Code of the response.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>response</code></td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Content of the response.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>gibbs/hub.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Store a response, to be consumed later.</span>

<span class="sd">    Args:</span>
<span class="sd">        req_id (str): Request unique identifier.</span>
<span class="sd">        code (int): Code of the response.</span>
<span class="sd">        response (Any): Content of the response.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Store the response if the req_id is recognized</span>
    <span class="k">if</span> <span class="n">req_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">req_states</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">responses</span><span class="p">[</span><span class="n">req_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">Response</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>

        <span class="c1"># Notify that we received the response</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">req_states</span><span class="p">[</span><span class="n">req_id</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Request #</span><span class="si">{</span><span class="n">req_id</span><span class="si">}</span><span class="s2"> was previously removed from response buffer. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Ignoring the response from this request...&quot;</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="gibbs.hub.RequestManager.wait_for" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">wait_for</span><span class="p">(</span><span class="n">req_id</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Async method that waits until we received the response corresponding
to the given request ID.</p>
<p>The method <code>pin</code> should be called before waiting with this method.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>req_id</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Request unique identifier.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>KeyError</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Exception raised if the request wasn't registered previously.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[int, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tuple[int, Any]: Code and content of the received response.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>gibbs/hub.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">wait_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Async method that waits until we received the response corresponding</span>
<span class="sd">    to the given request ID.</span>

<span class="sd">    The method `pin` should be called before waiting with this method.</span>

<span class="sd">    Args:</span>
<span class="sd">        req_id (str): Request unique identifier.</span>

<span class="sd">    Raises:</span>
<span class="sd">        KeyError: Exception raised if the request wasn&#39;t registered previously.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple[int, Any]: Code and content of the received response.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">req_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">req_states</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Request #</span><span class="si">{</span><span class="n">req_id</span><span class="si">}</span><span class="s2"> was not pinned, or was removed because of buffer overflow&quot;</span><span class="p">)</span>

    <span class="c1"># Wait for the receiving loop to receive the response</span>
    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">req_states</span><span class="p">[</span><span class="n">req_id</span><span class="p">]</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

    <span class="c1"># Once we get it, access the result</span>
    <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">responses</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">req_id</span><span class="p">)</span>

    <span class="c1"># Don&#39;t forget to remove the event</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">req_states</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">req_id</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">content</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="gibbs.hub.UserCodeException" class="doc doc-heading">
            <code>UserCodeException</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code>Exception</code></p>


        <p>Custom Exception for user-defined catched errors.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>t</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Traceback returned by the worker.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>gibbs/hub.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">UserCodeException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Custom Exception for user-defined catched errors.</span>

<span class="sd">    Args:</span>
<span class="sd">        t (str): Traceback returned by the worker.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exception raised in user-defined code. Traceback :</span><span class="se">\n</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="gibbs.hub.WorkerManager" class="doc doc-heading">
            <code>WorkerManager</code>


</h2>


    <div class="doc doc-contents ">


        <p>A helper class that takes care of managing workers.
Workers' address can be registered as available, and this class will make
sure to return address of workers that are available and alive.</p>
<p>A worker is considered as dead if we didn't receive any heartbeat within a
given interval.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>heartbeat_interval</code></td>
            <td>
                  <code>float</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Interval of time (in seconds) after which we
consider a worker to be dead.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>gibbs/hub.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">WorkerManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A helper class that takes care of managing workers.</span>
<span class="sd">    Workers&#39; address can be registered as available, and this class will make</span>
<span class="sd">    sure to return address of workers that are available and alive.</span>

<span class="sd">    A worker is considered as dead if we didn&#39;t receive any heartbeat within a</span>
<span class="sd">    given interval.</span>

<span class="sd">    Args:</span>
<span class="sd">        heartbeat_interval (float): Interval of time (in seconds) after which we</span>
<span class="sd">            consider a worker to be dead.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">heartbeat_interval</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">heartbeat_t</span> <span class="o">=</span> <span class="n">heartbeat_interval</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">w_ts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_access</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Condition</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">reckon</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Register the given address as available.</span>

<span class="sd">        Args:</span>
<span class="sd">            address (str): Address of the worker to register as available.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_access</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">w_ts</span><span class="p">[</span><span class="n">address</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">w_access</span><span class="o">.</span><span class="n">notify</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_next_worker</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve the next available and alive worker&#39;s address.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: Address of the available and alive worker.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_access</span><span class="p">:</span>
            <span class="c1"># Iterate workers until we find one that was alive recently</span>
            <span class="n">w_alive</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">w_alive</span><span class="p">:</span>
                <span class="c1"># If no workers are available, wait...</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_ts</span><span class="p">:</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_access</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

                <span class="n">address</span><span class="p">,</span> <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_ts</span><span class="o">.</span><span class="n">popitem</span><span class="p">()</span>
                <span class="n">w_alive</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">ts</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">heartbeat_t</span>

            <span class="k">return</span> <span class="n">address</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="gibbs.hub.WorkerManager.get_next_worker" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_next_worker</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Retrieve the next available and alive worker's address.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>str</code></td>            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Address of the available and alive worker.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>gibbs/hub.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">get_next_worker</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieve the next available and alive worker&#39;s address.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: Address of the available and alive worker.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_access</span><span class="p">:</span>
        <span class="c1"># Iterate workers until we find one that was alive recently</span>
        <span class="n">w_alive</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">w_alive</span><span class="p">:</span>
            <span class="c1"># If no workers are available, wait...</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_ts</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_access</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

            <span class="n">address</span><span class="p">,</span> <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_ts</span><span class="o">.</span><span class="n">popitem</span><span class="p">()</span>
            <span class="n">w_alive</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">ts</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">heartbeat_t</span>

        <span class="k">return</span> <span class="n">address</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="gibbs.hub.WorkerManager.reckon" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">reckon</span><span class="p">(</span><span class="n">address</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Register the given address as available.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>address</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Address of the worker to register as available.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>gibbs/hub.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">reckon</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Register the given address as available.</span>

<span class="sd">    Args:</span>
<span class="sd">        address (str): Address of the worker to register as available.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_access</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_ts</span><span class="p">[</span><span class="n">address</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_access</span><span class="o">.</span><span class="n">notify</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div><h2 id="constants">Constants</h2>


<div class="doc doc-object doc-module">



<a id="gibbs.hub"></a>
    <div class="doc doc-contents first">



  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="gibbs.hub.Hub" class="doc doc-heading">
            <code>Hub</code>


</h2>


    <div class="doc doc-contents ">


        <p>Class acting as a hub for all the requests to send. All requests sent
through this class will be automatically dispatched to connected workers,
will wait for the responses and return it.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>port</code></td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Port number to use for the sockets. Defaults to
DEFAULT_PORT.</p>
              </div>
            </td>
            <td>
                  <code><span title="gibbs.worker.DEFAULT_PORT">DEFAULT_PORT</span></code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>heartbeat_interval</code></td>
            <td>
                  <code>float</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Heartbeat interval used by the
workers, in seconds. Defaults to DEFAULT_HEARTBEAT_INTERVAL.</p>
              </div>
            </td>
            <td>
                  <code><span title="gibbs.worker.DEFAULT_HEARTBEAT_INTERVAL">DEFAULT_HEARTBEAT_INTERVAL</span></code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>resp_buffer_size</code></td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum response buffer size. Defaults
to RESPONSE_BUFFER_SIZE.</p>
              </div>
            </td>
            <td>
                  <code><span title="gibbs.hub.RESPONSE_BUFFER_SIZE">RESPONSE_BUFFER_SIZE</span></code>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>gibbs/hub.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Hub</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Class acting as a hub for all the requests to send. All requests sent</span>
<span class="sd">    through this class will be automatically dispatched to connected workers,</span>
<span class="sd">    will wait for the responses and return it.</span>

<span class="sd">    Args:</span>
<span class="sd">        port (int): Port number to use for the sockets. Defaults to</span>
<span class="sd">            DEFAULT_PORT.</span>
<span class="sd">        heartbeat_interval (float): Heartbeat interval used by the</span>
<span class="sd">            workers, in seconds. Defaults to DEFAULT_HEARTBEAT_INTERVAL.</span>
<span class="sd">        resp_buffer_size (int): Maximum response buffer size. Defaults</span>
<span class="sd">            to RESPONSE_BUFFER_SIZE.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_PORT</span><span class="p">,</span>
        <span class="n">heartbeat_interval</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">DEFAULT_HEARTBEAT_INTERVAL</span><span class="p">,</span>
        <span class="n">resp_buffer_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">RESPONSE_BUFFER_SIZE</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">heartbeat_t</span> <span class="o">=</span> <span class="n">heartbeat_interval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_manager</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">req_manager</span> <span class="o">=</span> <span class="n">RequestManager</span><span class="p">(</span><span class="n">resp_buffer_size</span><span class="o">=</span><span class="n">resp_buffer_size</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">receive_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Infinite loop for receiving responses from the workers.&quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># Receive stuff</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Receiving...&quot;</span><span class="p">)</span>
            <span class="n">address</span><span class="p">,</span> <span class="o">*</span><span class="n">frames</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">recv_multipart</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received something from worker #</span><span class="si">{</span><span class="n">address</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Since we received a response from this worker, it means it&#39;s ready for more !</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_manager</span><span class="o">.</span><span class="n">reckon</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">frames</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Answer the Ping</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Answering the ping&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">send_multipart</span><span class="p">([</span><span class="n">address</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">PONG</span><span class="p">])</span>
                <span class="k">continue</span>

            <span class="n">_</span><span class="p">,</span> <span class="n">resp</span> <span class="o">=</span> <span class="n">frames</span>
            <span class="n">req_id</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">res</span> <span class="o">=</span> <span class="n">msgpack</span><span class="o">.</span><span class="n">unpackb</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received response from request #</span><span class="si">{</span><span class="n">req_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">req_manager</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">req_id</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_start_if_not_started</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper method to ensure everything is properly started (socket is</span>
<span class="sd">        initialized, receiving loop is started, etc...).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Create what we need here in this process/context</span>
            <span class="n">context</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">asyncio</span><span class="o">.</span><span class="n">Context</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">ROUTER</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tcp://*:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">w_manager</span> <span class="o">=</span> <span class="n">WorkerManager</span><span class="p">(</span><span class="n">heartbeat_interval</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">heartbeat_t</span><span class="p">)</span>

            <span class="c1"># Fire and forget : infinite loop, taking care of receiving stuff from the socket</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting receiving loop...&quot;</span><span class="p">)</span>
            <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">receive_loop</span><span class="p">())</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Raw method to send a request. This method will do the following :</span>
<span class="sd">         * Start the receiving loop if it was not started</span>
<span class="sd">         * Get the address of the next worker ready (blocking)</span>
<span class="sd">         * Send the request to the worker</span>
<span class="sd">         * Wait for the response (blocking)</span>
<span class="sd">         * Return the result</span>

<span class="sd">        Args:</span>
<span class="sd">            *args: Positional arguments for the request.</span>
<span class="sd">            **kwargs: Keywords arguments for the request.</span>

<span class="sd">        Raises:</span>
<span class="sd">            UserCodeException: Exception raised if an exception was raised inside</span>
<span class="sd">                user-defined code on the worker side.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Any: The response for the request.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Before anything, if the receiving loop was not started, start it</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_if_not_started</span><span class="p">()</span>

        <span class="c1"># Assign a unique ID to the request</span>
        <span class="n">req_id</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span>

        <span class="c1"># Let the manager know that we are waiting for this request</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pinning request #</span><span class="si">{</span><span class="n">req_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">req_manager</span><span class="o">.</span><span class="n">pin</span><span class="p">(</span><span class="n">req_id</span><span class="p">)</span>

        <span class="c1"># Send the request</span>
        <span class="n">address</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_manager</span><span class="o">.</span><span class="n">get_next_worker</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sending request #</span><span class="si">{</span><span class="n">req_id</span><span class="si">}</span><span class="s2"> to worker #</span><span class="si">{</span><span class="n">address</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">send_multipart</span><span class="p">([</span><span class="n">address</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">msgpack</span><span class="o">.</span><span class="n">packb</span><span class="p">([</span><span class="n">req_id</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">])])</span>

        <span class="c1"># Wait until we receive the response</span>
        <span class="n">code</span><span class="p">,</span> <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">req_manager</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span><span class="n">req_id</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received result for request #</span><span class="si">{</span><span class="n">req_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Depending on what is the response, deal with it properly</span>
        <span class="k">if</span> <span class="n">code</span> <span class="o">==</span> <span class="n">CODE_FAILURE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UserCodeException</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">res</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">gibbs_timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">gibbs_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Main method, used to send a request to workers and get the result.</span>

<span class="sd">        This method is a wrapper around `_request`, providing additional</span>
<span class="sd">        functionalities :</span>
<span class="sd">         * Timeout</span>
<span class="sd">         * Automatic retries</span>

<span class="sd">        Args:</span>
<span class="sd">            *args: Positional arguments for the request.</span>
<span class="sd">            gibbs_timeout (float): Timeout for the request, in seconds.</span>
<span class="sd">                If `None` is given, block until the request is complete.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            gibbs_retries (int): Number of retries. This argument is</span>
<span class="sd">                used only if `gibbs_timeout` is not `None`. If `-1` is given,</span>
<span class="sd">                indefinitely retry. Defaults to 0.</span>
<span class="sd">            **kwargs: Keywords arguments for the request.</span>

<span class="sd">        Raises:</span>
<span class="sd">            asyncio.TimeoutError: Error raised if no response is received within</span>
<span class="sd">                the given timeout.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Any: The response for the request.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">gibbs_timeout</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">gibbs_retries</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Request failed : no response received within </span><span class="si">{</span><span class="n">gibbs_timeout</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
                <span class="k">raise</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">retries_left</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">gibbs_retries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Request failed : no response received within </span><span class="si">{</span><span class="n">gibbs_timeout</span><span class="si">}</span><span class="s2">s. Retrying </span><span class="si">{</span><span class="n">retries_left</span><span class="si">}</span><span class="s2"> times&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">gibbs_timeout</span><span class="o">=</span><span class="n">gibbs_timeout</span><span class="p">,</span> <span class="n">gibbs_retries</span><span class="o">=</span><span class="n">retries_left</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="gibbs.hub.Hub.receive_loop" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">receive_loop</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Infinite loop for receiving responses from the workers.</p>

            <details class="quote">
              <summary>Source code in <code>gibbs/hub.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">receive_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Infinite loop for receiving responses from the workers.&quot;&quot;&quot;</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># Receive stuff</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Receiving...&quot;</span><span class="p">)</span>
        <span class="n">address</span><span class="p">,</span> <span class="o">*</span><span class="n">frames</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">recv_multipart</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received something from worker #</span><span class="si">{</span><span class="n">address</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Since we received a response from this worker, it means it&#39;s ready for more !</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_manager</span><span class="o">.</span><span class="n">reckon</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">frames</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Answer the Ping</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Answering the ping&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">send_multipart</span><span class="p">([</span><span class="n">address</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">PONG</span><span class="p">])</span>
            <span class="k">continue</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">resp</span> <span class="o">=</span> <span class="n">frames</span>
        <span class="n">req_id</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">res</span> <span class="o">=</span> <span class="n">msgpack</span><span class="o">.</span><span class="n">unpackb</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received response from request #</span><span class="si">{</span><span class="n">req_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">req_manager</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">req_id</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="gibbs.hub.Hub.request" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">request</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">gibbs_timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gibbs_retries</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Main method, used to send a request to workers and get the result.</p>
<p>This method is a wrapper around <code>_request</code>, providing additional
functionalities :
 * Timeout
 * Automatic retries</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>*args</code></td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Positional arguments for the request.</p>
              </div>
            </td>
            <td>
                  <code>()</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>gibbs_timeout</code></td>
            <td>
                  <code>float</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Timeout for the request, in seconds.
If <code>None</code> is given, block until the request is complete.
Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>gibbs_retries</code></td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of retries. This argument is
used only if <code>gibbs_timeout</code> is not <code>None</code>. If <code>-1</code> is given,
indefinitely retry. Defaults to 0.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>**kwargs</code></td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Keywords arguments for the request.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="asyncio.TimeoutError">TimeoutError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Error raised if no response is received within
the given timeout.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>Any</code></td>            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The response for the request.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>gibbs/hub.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">gibbs_timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">gibbs_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Main method, used to send a request to workers and get the result.</span>

<span class="sd">    This method is a wrapper around `_request`, providing additional</span>
<span class="sd">    functionalities :</span>
<span class="sd">     * Timeout</span>
<span class="sd">     * Automatic retries</span>

<span class="sd">    Args:</span>
<span class="sd">        *args: Positional arguments for the request.</span>
<span class="sd">        gibbs_timeout (float): Timeout for the request, in seconds.</span>
<span class="sd">            If `None` is given, block until the request is complete.</span>
<span class="sd">            Defaults to None.</span>
<span class="sd">        gibbs_retries (int): Number of retries. This argument is</span>
<span class="sd">            used only if `gibbs_timeout` is not `None`. If `-1` is given,</span>
<span class="sd">            indefinitely retry. Defaults to 0.</span>
<span class="sd">        **kwargs: Keywords arguments for the request.</span>

<span class="sd">    Raises:</span>
<span class="sd">        asyncio.TimeoutError: Error raised if no response is received within</span>
<span class="sd">            the given timeout.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Any: The response for the request.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">gibbs_timeout</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">gibbs_retries</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Request failed : no response received within </span><span class="si">{</span><span class="n">gibbs_timeout</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">retries_left</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">gibbs_retries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Request failed : no response received within </span><span class="si">{</span><span class="n">gibbs_timeout</span><span class="si">}</span><span class="s2">s. Retrying </span><span class="si">{</span><span class="n">retries_left</span><span class="si">}</span><span class="s2"> times&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">gibbs_timeout</span><span class="o">=</span><span class="n">gibbs_timeout</span><span class="p">,</span> <span class="n">gibbs_retries</span><span class="o">=</span><span class="n">retries_left</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="gibbs.hub.RequestManager" class="doc doc-heading">
            <code>RequestManager</code>


</h2>


    <div class="doc doc-contents ">


        <p>A helper class that takes care of storing responses and waiting for the
right response.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>resp_buffer_size</code></td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum size of the response buffer.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>gibbs/hub.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">RequestManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A helper class that takes care of storing responses and waiting for the</span>
<span class="sd">    right response.</span>

<span class="sd">    Args:</span>
<span class="sd">        resp_buffer_size (int): Maximum size of the response buffer.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resp_buffer_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">resp_buffer_size</span> <span class="o">=</span> <span class="n">resp_buffer_size</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">responses</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">req_states</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">pin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pin a request ID. This is a necessary step when sending a request,</span>
<span class="sd">        so that the request can be awaited until a response is received.</span>
<span class="sd">        This method should be called for each `req_id` before calling `wait_for`.</span>

<span class="sd">        Args:</span>
<span class="sd">            req_id (str): Request unique identifier.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">req_states</span><span class="p">[</span><span class="n">req_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>

        <span class="c1"># Ensure we don&#39;t store too many requests</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">req_states</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">resp_buffer_size</span><span class="p">:</span>
            <span class="c1"># If it&#39;s the case, forget the oldest one</span>
            <span class="n">k</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">req_states</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Response buffer overflow (&gt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">resp_buffer_size</span><span class="si">}</span><span class="s2">). Forgetting oldest request : </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">req_states</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">responses</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">wait_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Async method that waits until we received the response corresponding</span>
<span class="sd">        to the given request ID.</span>

<span class="sd">        The method `pin` should be called before waiting with this method.</span>

<span class="sd">        Args:</span>
<span class="sd">            req_id (str): Request unique identifier.</span>

<span class="sd">        Raises:</span>
<span class="sd">            KeyError: Exception raised if the request wasn&#39;t registered previously.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[int, Any]: Code and content of the received response.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">req_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">req_states</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Request #</span><span class="si">{</span><span class="n">req_id</span><span class="si">}</span><span class="s2"> was not pinned, or was removed because of buffer overflow&quot;</span><span class="p">)</span>

        <span class="c1"># Wait for the receiving loop to receive the response</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">req_states</span><span class="p">[</span><span class="n">req_id</span><span class="p">]</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

        <span class="c1"># Once we get it, access the result</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">responses</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">req_id</span><span class="p">)</span>

        <span class="c1"># Don&#39;t forget to remove the event</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">req_states</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">req_id</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">content</span>

    <span class="k">def</span> <span class="nf">store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Store a response, to be consumed later.</span>

<span class="sd">        Args:</span>
<span class="sd">            req_id (str): Request unique identifier.</span>
<span class="sd">            code (int): Code of the response.</span>
<span class="sd">            response (Any): Content of the response.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Store the response if the req_id is recognized</span>
        <span class="k">if</span> <span class="n">req_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">req_states</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">responses</span><span class="p">[</span><span class="n">req_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">Response</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>

            <span class="c1"># Notify that we received the response</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">req_states</span><span class="p">[</span><span class="n">req_id</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Request #</span><span class="si">{</span><span class="n">req_id</span><span class="si">}</span><span class="s2"> was previously removed from response buffer. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Ignoring the response from this request...&quot;</span>
            <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="gibbs.hub.RequestManager.pin" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">pin</span><span class="p">(</span><span class="n">req_id</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Pin a request ID. This is a necessary step when sending a request,
so that the request can be awaited until a response is received.
This method should be called for each <code>req_id</code> before calling <code>wait_for</code>.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>req_id</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Request unique identifier.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>gibbs/hub.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">pin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Pin a request ID. This is a necessary step when sending a request,</span>
<span class="sd">    so that the request can be awaited until a response is received.</span>
<span class="sd">    This method should be called for each `req_id` before calling `wait_for`.</span>

<span class="sd">    Args:</span>
<span class="sd">        req_id (str): Request unique identifier.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">req_states</span><span class="p">[</span><span class="n">req_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>

    <span class="c1"># Ensure we don&#39;t store too many requests</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">req_states</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">resp_buffer_size</span><span class="p">:</span>
        <span class="c1"># If it&#39;s the case, forget the oldest one</span>
        <span class="n">k</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">req_states</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Response buffer overflow (&gt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">resp_buffer_size</span><span class="si">}</span><span class="s2">). Forgetting oldest request : </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">req_states</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">responses</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="gibbs.hub.RequestManager.store" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">store</span><span class="p">(</span><span class="n">req_id</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Store a response, to be consumed later.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>req_id</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Request unique identifier.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>code</code></td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Code of the response.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>response</code></td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Content of the response.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>gibbs/hub.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Store a response, to be consumed later.</span>

<span class="sd">    Args:</span>
<span class="sd">        req_id (str): Request unique identifier.</span>
<span class="sd">        code (int): Code of the response.</span>
<span class="sd">        response (Any): Content of the response.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Store the response if the req_id is recognized</span>
    <span class="k">if</span> <span class="n">req_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">req_states</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">responses</span><span class="p">[</span><span class="n">req_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">Response</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>

        <span class="c1"># Notify that we received the response</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">req_states</span><span class="p">[</span><span class="n">req_id</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Request #</span><span class="si">{</span><span class="n">req_id</span><span class="si">}</span><span class="s2"> was previously removed from response buffer. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Ignoring the response from this request...&quot;</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="gibbs.hub.RequestManager.wait_for" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">wait_for</span><span class="p">(</span><span class="n">req_id</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Async method that waits until we received the response corresponding
to the given request ID.</p>
<p>The method <code>pin</code> should be called before waiting with this method.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>req_id</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Request unique identifier.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>KeyError</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Exception raised if the request wasn't registered previously.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[int, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tuple[int, Any]: Code and content of the received response.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>gibbs/hub.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">wait_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Async method that waits until we received the response corresponding</span>
<span class="sd">    to the given request ID.</span>

<span class="sd">    The method `pin` should be called before waiting with this method.</span>

<span class="sd">    Args:</span>
<span class="sd">        req_id (str): Request unique identifier.</span>

<span class="sd">    Raises:</span>
<span class="sd">        KeyError: Exception raised if the request wasn&#39;t registered previously.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple[int, Any]: Code and content of the received response.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">req_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">req_states</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Request #</span><span class="si">{</span><span class="n">req_id</span><span class="si">}</span><span class="s2"> was not pinned, or was removed because of buffer overflow&quot;</span><span class="p">)</span>

    <span class="c1"># Wait for the receiving loop to receive the response</span>
    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">req_states</span><span class="p">[</span><span class="n">req_id</span><span class="p">]</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

    <span class="c1"># Once we get it, access the result</span>
    <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">responses</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">req_id</span><span class="p">)</span>

    <span class="c1"># Don&#39;t forget to remove the event</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">req_states</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">req_id</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">content</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="gibbs.hub.UserCodeException" class="doc doc-heading">
            <code>UserCodeException</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code>Exception</code></p>


        <p>Custom Exception for user-defined catched errors.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>t</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Traceback returned by the worker.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>gibbs/hub.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">UserCodeException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Custom Exception for user-defined catched errors.</span>

<span class="sd">    Args:</span>
<span class="sd">        t (str): Traceback returned by the worker.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exception raised in user-defined code. Traceback :</span><span class="se">\n</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="gibbs.hub.WorkerManager" class="doc doc-heading">
            <code>WorkerManager</code>


</h2>


    <div class="doc doc-contents ">


        <p>A helper class that takes care of managing workers.
Workers' address can be registered as available, and this class will make
sure to return address of workers that are available and alive.</p>
<p>A worker is considered as dead if we didn't receive any heartbeat within a
given interval.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>heartbeat_interval</code></td>
            <td>
                  <code>float</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Interval of time (in seconds) after which we
consider a worker to be dead.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>gibbs/hub.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">WorkerManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A helper class that takes care of managing workers.</span>
<span class="sd">    Workers&#39; address can be registered as available, and this class will make</span>
<span class="sd">    sure to return address of workers that are available and alive.</span>

<span class="sd">    A worker is considered as dead if we didn&#39;t receive any heartbeat within a</span>
<span class="sd">    given interval.</span>

<span class="sd">    Args:</span>
<span class="sd">        heartbeat_interval (float): Interval of time (in seconds) after which we</span>
<span class="sd">            consider a worker to be dead.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">heartbeat_interval</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">heartbeat_t</span> <span class="o">=</span> <span class="n">heartbeat_interval</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">w_ts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_access</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Condition</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">reckon</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Register the given address as available.</span>

<span class="sd">        Args:</span>
<span class="sd">            address (str): Address of the worker to register as available.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_access</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">w_ts</span><span class="p">[</span><span class="n">address</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">w_access</span><span class="o">.</span><span class="n">notify</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_next_worker</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve the next available and alive worker&#39;s address.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: Address of the available and alive worker.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_access</span><span class="p">:</span>
            <span class="c1"># Iterate workers until we find one that was alive recently</span>
            <span class="n">w_alive</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">w_alive</span><span class="p">:</span>
                <span class="c1"># If no workers are available, wait...</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_ts</span><span class="p">:</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_access</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

                <span class="n">address</span><span class="p">,</span> <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_ts</span><span class="o">.</span><span class="n">popitem</span><span class="p">()</span>
                <span class="n">w_alive</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">ts</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">heartbeat_t</span>

            <span class="k">return</span> <span class="n">address</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="gibbs.hub.WorkerManager.get_next_worker" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_next_worker</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Retrieve the next available and alive worker's address.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>str</code></td>            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Address of the available and alive worker.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>gibbs/hub.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">get_next_worker</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieve the next available and alive worker&#39;s address.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: Address of the available and alive worker.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_access</span><span class="p">:</span>
        <span class="c1"># Iterate workers until we find one that was alive recently</span>
        <span class="n">w_alive</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">w_alive</span><span class="p">:</span>
            <span class="c1"># If no workers are available, wait...</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_ts</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_access</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

            <span class="n">address</span><span class="p">,</span> <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_ts</span><span class="o">.</span><span class="n">popitem</span><span class="p">()</span>
            <span class="n">w_alive</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">ts</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">heartbeat_t</span>

        <span class="k">return</span> <span class="n">address</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="gibbs.hub.WorkerManager.reckon" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">reckon</span><span class="p">(</span><span class="n">address</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Register the given address as available.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>address</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Address of the worker to register as available.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>gibbs/hub.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">reckon</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Register the given address as available.</span>

<span class="sd">    Args:</span>
<span class="sd">        address (str): Address of the worker to register as available.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_access</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_ts</span><span class="p">[</span><span class="n">address</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_access</span><span class="o">.</span><span class="n">notify</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<a id="gibbs.worker"></a>
    <div class="doc doc-contents first">



  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="gibbs.worker.Worker" class="doc doc-heading">
            <code>Worker</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="multiprocessing.Process">Process</span></code></p>


        <p>Define a worker process. This worker process indefinitely waits for
requests on a socket. Upon receiving a request, it processes it with the
worker class provided, and return the response.</p>
<p>After creating the Worker object, you have 2 different ways to run it :
 * <code>worker.run()</code> : It will run in the current process directly (blocking,
    infinite loop).
 * <code>worker.start()</code> : It will start a different process and start the code
    there (non-blocking).</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>worker_cls</code></td>
            <td>
                  <code><span title="typing.Callable">Callable</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Worker class containing the code that will be used
to process requests.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>gibbs_host</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Host of the Hub. Defaults to "localhost".</p>
              </div>
            </td>
            <td>
                  <code>&#39;localhost&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>gibbs_port</code></td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Port of the Hub. Defaults to DEFAULT_PORT.</p>
              </div>
            </td>
            <td>
                  <code><span title="gibbs.worker.DEFAULT_PORT">DEFAULT_PORT</span></code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>gibbs_heartbeat_interval</code></td>
            <td>
                  <code>float</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Heartbeat interval between the
worker and the Hub. Defaults to DEFAULT_HEARTBEAT_INTERVAL.</p>
              </div>
            </td>
            <td>
                  <code><span title="gibbs.worker.DEFAULT_HEARTBEAT_INTERVAL">DEFAULT_HEARTBEAT_INTERVAL</span></code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>gibbs_reset_after_n_miss</code></td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of missed heartbeats
allowed before hard-resetting the socket and retrying. Defaults to
DEFAULT_RESET_AFTER_N_MISS.</p>
              </div>
            </td>
            <td>
                  <code><span title="gibbs.worker.DEFAULT_RESET_AFTER_N_MISS">DEFAULT_RESET_AFTER_N_MISS</span></code>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>gibbs/worker.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Worker</span><span class="p">(</span><span class="n">Process</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Define a worker process. This worker process indefinitely waits for</span>
<span class="sd">    requests on a socket. Upon receiving a request, it processes it with the</span>
<span class="sd">    worker class provided, and return the response.</span>

<span class="sd">    After creating the Worker object, you have 2 different ways to run it :</span>
<span class="sd">     * `worker.run()` : It will run in the current process directly (blocking,</span>
<span class="sd">        infinite loop).</span>
<span class="sd">     * `worker.start()` : It will start a different process and start the code</span>
<span class="sd">        there (non-blocking).</span>

<span class="sd">    Args:</span>
<span class="sd">        worker_cls (Callable): Worker class containing the code that will be used</span>
<span class="sd">            to process requests.</span>
<span class="sd">        gibbs_host (str): Host of the Hub. Defaults to &quot;localhost&quot;.</span>
<span class="sd">        gibbs_port (int): Port of the Hub. Defaults to DEFAULT_PORT.</span>
<span class="sd">        gibbs_heartbeat_interval (float): Heartbeat interval between the</span>
<span class="sd">            worker and the Hub. Defaults to DEFAULT_HEARTBEAT_INTERVAL.</span>
<span class="sd">        gibbs_reset_after_n_miss (int): Number of missed heartbeats</span>
<span class="sd">            allowed before hard-resetting the socket and retrying. Defaults to</span>
<span class="sd">            DEFAULT_RESET_AFTER_N_MISS.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">worker_cls</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="n">gibbs_host</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;localhost&quot;</span><span class="p">,</span>
        <span class="n">gibbs_port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_PORT</span><span class="p">,</span>
        <span class="n">gibbs_heartbeat_interval</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">DEFAULT_HEARTBEAT_INTERVAL</span><span class="p">,</span>
        <span class="n">gibbs_reset_after_n_miss</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_RESET_AFTER_N_MISS</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">worker_cls</span> <span class="o">=</span> <span class="n">worker_cls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker_args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">identity</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">gibbs_host</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">gibbs_port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">heartbeat_t</span> <span class="o">=</span> <span class="n">gibbs_heartbeat_interval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_n_miss</span> <span class="o">=</span> <span class="n">gibbs_reset_after_n_miss</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">waiting_pong</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">create_socket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Context</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Socket</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper method to create a socket, setting its identity and connecting</span>
<span class="sd">        to the Hub.</span>

<span class="sd">        Args:</span>
<span class="sd">            context (zmq.Context): ZMQ context to use.</span>

<span class="sd">        Returns:</span>
<span class="sd">            zmq.Socket: Initialized and connected socket, ready to use.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create the socket, set its identity</span>
        <span class="n">socket</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">DEALER</span><span class="p">)</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">setsockopt_string</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">IDENTITY</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">identity</span><span class="p">)</span>

        <span class="c1"># Connect to the Hub</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tcp://</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">socket</span>

    <span class="k">def</span> <span class="nf">create_term_socket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Context</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Socket</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper method to create a termination socket.</span>

<span class="sd">        Basically it creates 2 sockets, bind/connect them together. One socket</span>
<span class="sd">        will be used to send a termination signal, and the other is returned and</span>
<span class="sd">        used to receive the termination signal.</span>

<span class="sd">        Args:</span>
<span class="sd">            context (zmq.Context): ZMQ context to use.</span>

<span class="sd">        Returns:</span>
<span class="sd">            zmq.Socket: Initialized and connected socket, ready to use.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create the socket than will send the termination ping</span>
        <span class="n">term_snd_socket</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">REQ</span><span class="p">)</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">term_snd_socket</span><span class="o">.</span><span class="n">bind_to_random_port</span><span class="p">(</span><span class="s2">&quot;tcp://127.0.0.1&quot;</span><span class="p">)</span>

        <span class="c1"># Then define the behavior on how to send the termination ping</span>
        <span class="k">def</span> <span class="nf">send_term</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Sending termination ping...&quot;</span><span class="p">)</span>
            <span class="c1"># Send something on the termination socket, it doesn&#39;t matter what</span>
            <span class="n">term_snd_socket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">PING</span><span class="p">)</span>

        <span class="c1"># We send the termination ping upon receiving these signals</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="n">send_term</span><span class="p">)</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">send_term</span><span class="p">)</span>

        <span class="c1"># And finally create the socket that we will use to receive the termination signal</span>
        <span class="n">term_rcv_socket</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">REP</span><span class="p">)</span>
        <span class="n">term_rcv_socket</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tcp://localhost:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">term_rcv_socket</span>

    <span class="k">def</span> <span class="nf">reset_socket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">socket</span><span class="p">:</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Socket</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">poller</span><span class="p">:</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Poller</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Socket</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper method to reset the given socket.</span>

<span class="sd">        This method unregister the socket from the given poller, close the</span>
<span class="sd">        socket, and then recreate the socket and register this new socket in the</span>
<span class="sd">        poller.</span>

<span class="sd">        Args:</span>
<span class="sd">            socket (zmq.Socket): ZMQ socket to reset.</span>
<span class="sd">            context (zmq.Context): ZMQ context to use.</span>
<span class="sd">            poller (zmq.Poller): ZMQ poller where the socket is registered.</span>

<span class="sd">        Returns:</span>
<span class="sd">            zmq.Socket: Initialized and connected socket, ready to use.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Close the existing socket</span>
        <span class="n">poller</span><span class="o">.</span><span class="n">unregister</span><span class="p">(</span><span class="n">socket</span><span class="p">)</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">linger</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Recreate the socket</span>
        <span class="n">socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_socket</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="n">poller</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">zmq</span><span class="o">.</span><span class="n">POLLIN</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">socket</span>

    <span class="k">def</span> <span class="nf">ping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">socket</span><span class="p">:</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Socket</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper method used for the heartbeat. Also takes care of keeping the</span>
<span class="sd">        counter of heartbeats up-to-date.</span>

<span class="sd">        Args:</span>
<span class="sd">            socket (zmq.Socket): Socket to use to send the heartbeat.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Sending ping...&quot;</span><span class="p">)</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">PING</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">waiting_pong</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Main method. It will initialize the worker class, and enter an</span>
<span class="sd">        infinite loop, waiting for requests. Whenever a request is received, it</span>
<span class="sd">        processes it with the code provided in the constructor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Instanciate the worker</span>
        <span class="n">worker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_cls</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">worker_args</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">worker_kwargs</span><span class="p">)</span>

        <span class="c1"># Initialize what we need for handling sockets</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Context</span><span class="p">()</span>
        <span class="n">poller</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Poller</span><span class="p">()</span>

        <span class="c1"># Create the socket for termination</span>
        <span class="n">term_socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_term_socket</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="n">poller</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">term_socket</span><span class="p">,</span> <span class="n">zmq</span><span class="o">.</span><span class="n">POLLIN</span><span class="p">)</span>

        <span class="c1"># Create the socket connecting to the hub</span>
        <span class="n">socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_socket</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="n">poller</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">zmq</span><span class="o">.</span><span class="n">POLLIN</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Worker ready to roll&quot;</span><span class="p">)</span>

        <span class="c1"># Tell the Hub we are ready</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ping</span><span class="p">(</span><span class="n">socket</span><span class="p">)</span>

        <span class="c1"># Indefinitely wait for requests : when we are done with one request,</span>
        <span class="c1"># we wait for the next one</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Waiting for request...&quot;</span><span class="p">)</span>
            <span class="n">events</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">poller</span><span class="o">.</span><span class="n">poll</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">heartbeat_t</span> <span class="o">*</span> <span class="n">MS</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">term_socket</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Termination signal received, shutting down gracefully&quot;</span><span class="p">)</span>
                <span class="k">break</span>

            <span class="k">if</span> <span class="n">socket</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">workload</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">recv_multipart</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">NOBLOCK</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Received something !&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">waiting_pong</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Didn&#39;t receive anything for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">heartbeat_t</span><span class="si">}</span><span class="s2">s (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">waiting_pong</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">waiting_pong</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_n_miss</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;The Hub is not answering, even after </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">waiting_pong</span><span class="si">}</span><span class="s2"> missed pings... &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;Resetting the socket&quot;</span>
                    <span class="p">)</span>
                    <span class="n">socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_socket</span><span class="p">(</span><span class="n">socket</span><span class="o">=</span><span class="n">socket</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span> <span class="n">poller</span><span class="o">=</span><span class="n">poller</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">waiting_pong</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="c1"># We didn&#39;t receive anything for some time, try to ping again</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ping</span><span class="p">(</span><span class="n">socket</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">workload</span> <span class="o">==</span> <span class="n">PONG</span><span class="p">:</span>
                <span class="c1"># Just a Pong, ignore it</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;It was just a pong...&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># From here the Hub sent us an actual request</span>
            <span class="n">req_id</span><span class="p">,</span> <span class="n">req_args</span><span class="p">,</span> <span class="n">req_kwargs</span> <span class="o">=</span> <span class="n">msgpack</span><span class="o">.</span><span class="n">unpackb</span><span class="p">(</span><span class="n">workload</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Request #</span><span class="si">{</span><span class="n">req_id</span><span class="si">}</span><span class="s2"> received&quot;</span><span class="p">)</span>

            <span class="c1"># Call worker&#39;s code with the request arguments</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">worker</span><span class="p">(</span><span class="o">*</span><span class="n">req_args</span><span class="p">,</span> <span class="o">**</span><span class="n">req_kwargs</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exception in user-defined __call__ method : </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                <span class="n">socket</span><span class="o">.</span><span class="n">send_multipart</span><span class="p">([</span><span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">msgpack</span><span class="o">.</span><span class="n">packb</span><span class="p">([</span><span class="n">req_id</span><span class="p">,</span> <span class="n">CODE_FAILURE</span><span class="p">,</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()])])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Sending back the response&quot;</span><span class="p">)</span>
                <span class="n">socket</span><span class="o">.</span><span class="n">send_multipart</span><span class="p">([</span><span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">msgpack</span><span class="o">.</span><span class="n">packb</span><span class="p">([</span><span class="n">req_id</span><span class="p">,</span> <span class="n">CODE_SUCCESS</span><span class="p">,</span> <span class="n">res</span><span class="p">])])</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Worker is shut down&quot;</span><span class="p">)</span>
        <span class="n">quit</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="gibbs.worker.Worker.create_socket" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_socket</span><span class="p">(</span><span class="n">context</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Helper method to create a socket, setting its identity and connecting
to the Hub.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>context</code></td>
            <td>
                  <code><span title="zmq.Context">Context</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ZMQ context to use.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="zmq.Socket">Socket</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>zmq.Socket: Initialized and connected socket, ready to use.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>gibbs/worker.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">create_socket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Context</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Socket</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper method to create a socket, setting its identity and connecting</span>
<span class="sd">    to the Hub.</span>

<span class="sd">    Args:</span>
<span class="sd">        context (zmq.Context): ZMQ context to use.</span>

<span class="sd">    Returns:</span>
<span class="sd">        zmq.Socket: Initialized and connected socket, ready to use.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create the socket, set its identity</span>
    <span class="n">socket</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">DEALER</span><span class="p">)</span>
    <span class="n">socket</span><span class="o">.</span><span class="n">setsockopt_string</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">IDENTITY</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">identity</span><span class="p">)</span>

    <span class="c1"># Connect to the Hub</span>
    <span class="n">socket</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tcp://</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">socket</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="gibbs.worker.Worker.create_term_socket" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_term_socket</span><span class="p">(</span><span class="n">context</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Helper method to create a termination socket.</p>
<p>Basically it creates 2 sockets, bind/connect them together. One socket
will be used to send a termination signal, and the other is returned and
used to receive the termination signal.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>context</code></td>
            <td>
                  <code><span title="zmq.Context">Context</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ZMQ context to use.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="zmq.Socket">Socket</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>zmq.Socket: Initialized and connected socket, ready to use.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>gibbs/worker.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">create_term_socket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Context</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Socket</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper method to create a termination socket.</span>

<span class="sd">    Basically it creates 2 sockets, bind/connect them together. One socket</span>
<span class="sd">    will be used to send a termination signal, and the other is returned and</span>
<span class="sd">    used to receive the termination signal.</span>

<span class="sd">    Args:</span>
<span class="sd">        context (zmq.Context): ZMQ context to use.</span>

<span class="sd">    Returns:</span>
<span class="sd">        zmq.Socket: Initialized and connected socket, ready to use.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create the socket than will send the termination ping</span>
    <span class="n">term_snd_socket</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">REQ</span><span class="p">)</span>
    <span class="n">port</span> <span class="o">=</span> <span class="n">term_snd_socket</span><span class="o">.</span><span class="n">bind_to_random_port</span><span class="p">(</span><span class="s2">&quot;tcp://127.0.0.1&quot;</span><span class="p">)</span>

    <span class="c1"># Then define the behavior on how to send the termination ping</span>
    <span class="k">def</span> <span class="nf">send_term</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Sending termination ping...&quot;</span><span class="p">)</span>
        <span class="c1"># Send something on the termination socket, it doesn&#39;t matter what</span>
        <span class="n">term_snd_socket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">PING</span><span class="p">)</span>

    <span class="c1"># We send the termination ping upon receiving these signals</span>
    <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="n">send_term</span><span class="p">)</span>
    <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">send_term</span><span class="p">)</span>

    <span class="c1"># And finally create the socket that we will use to receive the termination signal</span>
    <span class="n">term_rcv_socket</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">REP</span><span class="p">)</span>
    <span class="n">term_rcv_socket</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tcp://localhost:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">term_rcv_socket</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="gibbs.worker.Worker.ping" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">ping</span><span class="p">(</span><span class="n">socket</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Helper method used for the heartbeat. Also takes care of keeping the
counter of heartbeats up-to-date.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>socket</code></td>
            <td>
                  <code><span title="zmq.Socket">Socket</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Socket to use to send the heartbeat.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>gibbs/worker.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">ping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">socket</span><span class="p">:</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Socket</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper method used for the heartbeat. Also takes care of keeping the</span>
<span class="sd">    counter of heartbeats up-to-date.</span>

<span class="sd">    Args:</span>
<span class="sd">        socket (zmq.Socket): Socket to use to send the heartbeat.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Sending ping...&quot;</span><span class="p">)</span>
    <span class="n">socket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">PING</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">waiting_pong</span> <span class="o">+=</span> <span class="mi">1</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="gibbs.worker.Worker.reset_socket" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">reset_socket</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">poller</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Helper method to reset the given socket.</p>
<p>This method unregister the socket from the given poller, close the
socket, and then recreate the socket and register this new socket in the
poller.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>socket</code></td>
            <td>
                  <code><span title="zmq.Socket">Socket</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ZMQ socket to reset.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>context</code></td>
            <td>
                  <code><span title="zmq.Context">Context</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ZMQ context to use.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>poller</code></td>
            <td>
                  <code><span title="zmq.Poller">Poller</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ZMQ poller where the socket is registered.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="zmq.Socket">Socket</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>zmq.Socket: Initialized and connected socket, ready to use.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>gibbs/worker.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">reset_socket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">socket</span><span class="p">:</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Socket</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">poller</span><span class="p">:</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Poller</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Socket</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper method to reset the given socket.</span>

<span class="sd">    This method unregister the socket from the given poller, close the</span>
<span class="sd">    socket, and then recreate the socket and register this new socket in the</span>
<span class="sd">    poller.</span>

<span class="sd">    Args:</span>
<span class="sd">        socket (zmq.Socket): ZMQ socket to reset.</span>
<span class="sd">        context (zmq.Context): ZMQ context to use.</span>
<span class="sd">        poller (zmq.Poller): ZMQ poller where the socket is registered.</span>

<span class="sd">    Returns:</span>
<span class="sd">        zmq.Socket: Initialized and connected socket, ready to use.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Close the existing socket</span>
    <span class="n">poller</span><span class="o">.</span><span class="n">unregister</span><span class="p">(</span><span class="n">socket</span><span class="p">)</span>
    <span class="n">socket</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">linger</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Recreate the socket</span>
    <span class="n">socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_socket</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
    <span class="n">poller</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">zmq</span><span class="o">.</span><span class="n">POLLIN</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">socket</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="gibbs.worker.Worker.run" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">run</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Main method. It will initialize the worker class, and enter an
infinite loop, waiting for requests. Whenever a request is received, it
processes it with the code provided in the constructor.</p>

            <details class="quote">
              <summary>Source code in <code>gibbs/worker.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Main method. It will initialize the worker class, and enter an</span>
<span class="sd">    infinite loop, waiting for requests. Whenever a request is received, it</span>
<span class="sd">    processes it with the code provided in the constructor.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Instanciate the worker</span>
    <span class="n">worker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_cls</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">worker_args</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">worker_kwargs</span><span class="p">)</span>

    <span class="c1"># Initialize what we need for handling sockets</span>
    <span class="n">context</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Context</span><span class="p">()</span>
    <span class="n">poller</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Poller</span><span class="p">()</span>

    <span class="c1"># Create the socket for termination</span>
    <span class="n">term_socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_term_socket</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
    <span class="n">poller</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">term_socket</span><span class="p">,</span> <span class="n">zmq</span><span class="o">.</span><span class="n">POLLIN</span><span class="p">)</span>

    <span class="c1"># Create the socket connecting to the hub</span>
    <span class="n">socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_socket</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
    <span class="n">poller</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">zmq</span><span class="o">.</span><span class="n">POLLIN</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Worker ready to roll&quot;</span><span class="p">)</span>

    <span class="c1"># Tell the Hub we are ready</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ping</span><span class="p">(</span><span class="n">socket</span><span class="p">)</span>

    <span class="c1"># Indefinitely wait for requests : when we are done with one request,</span>
    <span class="c1"># we wait for the next one</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Waiting for request...&quot;</span><span class="p">)</span>
        <span class="n">events</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">poller</span><span class="o">.</span><span class="n">poll</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">heartbeat_t</span> <span class="o">*</span> <span class="n">MS</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">term_socket</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Termination signal received, shutting down gracefully&quot;</span><span class="p">)</span>
            <span class="k">break</span>

        <span class="k">if</span> <span class="n">socket</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">workload</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">recv_multipart</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">NOBLOCK</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Received something !&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">waiting_pong</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Didn&#39;t receive anything for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">heartbeat_t</span><span class="si">}</span><span class="s2">s (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">waiting_pong</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">waiting_pong</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_n_miss</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The Hub is not answering, even after </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">waiting_pong</span><span class="si">}</span><span class="s2"> missed pings... &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Resetting the socket&quot;</span>
                <span class="p">)</span>
                <span class="n">socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_socket</span><span class="p">(</span><span class="n">socket</span><span class="o">=</span><span class="n">socket</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span> <span class="n">poller</span><span class="o">=</span><span class="n">poller</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">waiting_pong</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># We didn&#39;t receive anything for some time, try to ping again</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ping</span><span class="p">(</span><span class="n">socket</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">workload</span> <span class="o">==</span> <span class="n">PONG</span><span class="p">:</span>
            <span class="c1"># Just a Pong, ignore it</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;It was just a pong...&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># From here the Hub sent us an actual request</span>
        <span class="n">req_id</span><span class="p">,</span> <span class="n">req_args</span><span class="p">,</span> <span class="n">req_kwargs</span> <span class="o">=</span> <span class="n">msgpack</span><span class="o">.</span><span class="n">unpackb</span><span class="p">(</span><span class="n">workload</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Request #</span><span class="si">{</span><span class="n">req_id</span><span class="si">}</span><span class="s2"> received&quot;</span><span class="p">)</span>

        <span class="c1"># Call worker&#39;s code with the request arguments</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">worker</span><span class="p">(</span><span class="o">*</span><span class="n">req_args</span><span class="p">,</span> <span class="o">**</span><span class="n">req_kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exception in user-defined __call__ method : </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="n">socket</span><span class="o">.</span><span class="n">send_multipart</span><span class="p">([</span><span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">msgpack</span><span class="o">.</span><span class="n">packb</span><span class="p">([</span><span class="n">req_id</span><span class="p">,</span> <span class="n">CODE_FAILURE</span><span class="p">,</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()])])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Sending back the response&quot;</span><span class="p">)</span>
            <span class="n">socket</span><span class="o">.</span><span class="n">send_multipart</span><span class="p">([</span><span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">msgpack</span><span class="o">.</span><span class="n">packb</span><span class="p">([</span><span class="n">req_id</span><span class="p">,</span> <span class="n">CODE_SUCCESS</span><span class="p">,</span> <span class="n">res</span><span class="p">])])</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Worker is shut down&quot;</span><span class="p">)</span>
    <span class="n">quit</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.sections"], "search": "../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../assets/javascripts/bundle.525ec568.min.js"></script>
      
    
  </body>
</html>